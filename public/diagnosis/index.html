<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>YHD AI Diagnosis</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/style.css?v=37">
    <link rel="stylesheet" href="css/components.css">

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js" charset="utf-8"></script>

    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
        xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tYHuRgEXEBOBS6qqSL9KxXfGPRCRHpTAfUuiQQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Global Helper Functions -->
    <script>
        const escapeHtmlFallback = function (unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;").replace(/\//g, "&#x2F;");
        };

        function initializeAppFailureFallback(errorMessage) {
            console.error("[initializeAppFailureFallback] Triggered with:", errorMessage);
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) loadingScreen.style.display = 'none';
            const bodyElement = document.body || document.createElement('body');
            const safeErrorMessage = escapeHtmlFallback(errorMessage || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼");
            bodyElement.innerHTML = `<div style="padding: 20px; text-align: center; color: red; background-color: #fff0f0; border: 1px solid red; border-radius: 8px; max-width: 600px; margin: 20px auto;"><h2>ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼</h2><p>${safeErrorMessage}</p><p>æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p></div>`;
            if (!document.body) document.documentElement.appendChild(bodyElement);
            bodyElement.style.cssText = `display: flex; justify-content: center; align-items: flex-start; padding-top: 50px; min-height: 100vh; background-color: #f8fafc;`;
        }
    </script>

</head>

<body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading-screen" class="loading-container active">
        <div class="spinner"></div>
        <p>ã‚¢ãƒ—ãƒªã‚’æº–å‚™ã—ã¦ã„ã¾ã™...</p>
    </div>

    <!-- Phase 1: Opening -->
    <div id="phase1" class="phase-container">
        <div class="p1-layout">
            <div class="p1-left">
                <img src="images/YHDlogo2.gif" alt="YHD AI Diagnosis Logo" class="p1-logo">
            </div>
            <div class="p1-right">
                <div class="p1-text-group">
                    <h1 class="logo-text-1">YHD Ã— AI</h1>
                    <h2 class="logo-text-2">ã€ä¼¼åˆã‚ã›è¨ºæ–­ã€</h2>
                    <p id="user-greeting" class="user-greeting"></p>
                    <p class="p1-description">
                        ãŠå®¢æ§˜ã®ã€ä¼¼åˆã†ã€ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«<br>
                        AIãŒåˆ†æã—ã€æœ€é©ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä¼ãˆã¾ã™âœ¨
                    </p>
                    <button id="start-btn" class="btn-primary">è¨ºæ–­ã‚’å§‹ã‚ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 2: Profile Input -->
    <div id="phase2" class="phase-container">
        <div class="card landscape-card">
            <div class="p2-layout">
                <div class="p2-header">
                    <h2 class="form-title">Profile</h2>
                </div>

                <div class="p2-left">
                    <div class="form-group">
                        <label for="display-name">ãŠåå‰</label>
                        <input type="text" id="display-name" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>æ€§åˆ¥</label>
                        <div class="gender-selection">
                            <input type="radio" id="female" name="gender" value="female" checked>
                            <label for="female">å¥³æ€§</label>

                            <input type="radio" id="male" name="gender" value="male">
                            <label for="male">ç”·æ€§</label>

                            <input type="radio" id="other" name="gender" value="other">
                            <label for="other">ãã®ä»–</label>
                        </div>
                    </div>
                    <div class="p2-footer">
                        <button id="next-to-upload-btn" class="btn-primary">For Materials</button>
                    </div>
                </div>

                <div class="p2-right">
                    <div class="form-group">
                        <label for="user-requests">ã”å¸Œæœ›ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚„ã”è¦æœ› (ä»»æ„)</label>
                        <textarea id="user-requests" class="form-control" rows="6"
                            placeholder="ï¼ˆä¾‹ï¼‰ã‚«ãƒƒãƒˆã¨ã‚«ãƒ©ãƒ¼å¸Œæœ›ã€‚èµ¤ã¿ãŒå‡ºãªã„ã‚ˆã†ã«ã—ãŸã„ã€‚"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="inspiration-image-input">ã”å¸Œæœ›ã®ã‚¹ã‚¿ã‚¤ãƒ«å†™çœŸ (ä»»æ„)</label>
                        <input type="file" id="inspiration-image-input" class="file-input visually-hidden"
                            accept="image/*">
                        <div id="inspiration-upload-container" class="inspiration-upload-container">
                            <div class="inspiration-preview-area">
                                <img id="inspiration-image-preview" src="images/AI.png" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                            </div>
                            <div class="inspiration-upload-info">
                                <h3 id="inspiration-upload-title">å†™çœŸã‚’é¸æŠ</h3>
                                <p id="inspiration-upload-status">ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’é¸æŠ</p>
                                <button id="inspiration-upload-btn" class="btn-outline-small">é¸æŠ</button>
                            </div>
                            <button id="inspiration-delete-btn" class="btn-delete" style="display: none;">å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 3: Materials -->
    <div id="phase3" class="phase-container">
        <div class="card landscape-card">
            <div class="p3-layout">
                <div class="p3-header">
                    <h2 class="form-title-center">Materials</h2>
                </div>

                <div class="p3-grid-5" id="phase3-viewer-grid">
                    <div class="p3-item" id="view-item-front-photo">
                        <div class="p3-label">Photo:Front</div>
                        <div class="viewer-thumbnail" id="thumb-item-front-photo"></div>
                        <span class="p3-status status-badge">Pending</span>
                    </div>
                    <div class="p3-item" id="view-item-side-photo">
                        <div class="p3-label">Photo:Side</div>
                        <div class="viewer-thumbnail" id="thumb-item-side-photo"></div>
                        <span class="p3-status status-badge">Pending</span>
                    </div>
                    <div class="p3-item" id="view-item-back-photo">
                        <div class="p3-label">Photo:Back</div>
                        <div class="viewer-thumbnail" id="thumb-item-back-photo"></div>
                        <span class="p3-status status-badge">Pending</span>
                    </div>
                    <div class="p3-item" id="view-item-front-video">
                        <div class="p3-label">Video:Front</div>
                        <div class="viewer-thumbnail" id="thumb-item-front-video"></div>
                        <span class="p3-status status-badge">Pending</span>
                    </div>
                    <div class="p3-item" id="view-item-back-video">
                        <div class="p3-label">Video:Back</div>
                        <div class="viewer-thumbnail" id="thumb-item-back-video"></div>
                        <span class="p3-status status-badge">Pending</span>
                    </div>
                </div>

                <div class="p3-footer">
                    <button id="reload-viewer-btn" class="btn-outline">Reload</button>
                    <div class="p3-actions-main">
                        <button id="request-diagnosis-btn-viewer" class="btn-primary" disabled>Start Diagnosis</button>
                        <p class="status-note">â€»Waiting for all materials</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>
    </div>

    <!-- Phase 3.5: AI Loading (Redesigned for 23" Monitor) -->
    <div id="phase3.5" class="phase-container">
        <div class="p35-layout">
            <div class="p35-left">
                <img src="images/YHDlogo2.gif" alt="YHD AI Diagnosis Loading" class="p35-logo">
            </div>
            <div class="p35-right">
                <div class="spinner-large"></div>
                <div class="p35-status-group">
                    <h2 class="p35-title">AIãŒè¨ºæ–­ä¸­ã§ã™</h2>
                    <p class="p35-subtitle" id="diagnosis-status-text">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 4: Diagnosis Result (Perfect Match for Ideal Layout) -->
    <div id="phase4" class="phase-container">
        <div class="card landscape-card no-scroll-container">
            <div class="p4-layout">
                <div class="p4-header">
                    <h2 class="form-title-center">AI Diagnosis</h2>
                </div>

                <!-- 1st Row -->
                <div class="result-section no-margin">
                    <h3 class="result-title-center"><img src="images/é¡”è¨ºæ–­.png" alt="" class="result-icon"> ãŠé¡”ã®ç‰¹å¾´</h3>
                    <div id="face-results" class="result-grid-split"></div>
                </div>
                <div class="result-section no-margin">
                    <h3 class="result-title-center"><img src="images/éª¨æ ¼è¨ºæ–­.png" alt="" class="result-icon"> éª¨æ ¼ãƒ»ãƒœãƒ‡ã‚£</h3>
                    <div id="skeleton-results" class="result-grid-split"></div>
                </div>

                <!-- 2nd Row -->
                <div class="result-section no-margin">
                    <h3 class="result-title-center"><img src="images/ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«.png" alt="" class="result-icon"> ç¾åœ¨ã®é«ªã®çŠ¶æ…‹
                    </h3>
                    <div id="hair-condition-results" class="result-grid-split"></div>
                </div>
                <div class="result-section no-margin">
                    <h3 class="result-title-center"><img src="images/ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼.png" alt="" class="result-icon"> ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ã‚«ãƒ©ãƒ¼
                    </h3>
                    <div id="personal-color-results" class="result-grid-split"></div>
                </div>

                <div class="p4-footer">
                    <button id="save-phase4-btn" class="btn-outline-wide">ç”»åƒä¿å­˜</button>
                    <button id="next-to-proposal-btn" class="btn-tiffany-wide">AIææ¡ˆã‚’è¦‹ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 5: AI Style Proposal (Hair Focused - 2 Columns) -->
    <div id="phase5" class="phase-container">
        <div class="card landscape-card no-scroll-container">
            <div class="p5-layout-2col">
                <div class="p5-header">
                    <h2 class="form-title-center">AI Style Proposal</h2>
                </div>

                <!-- Left Column: Hair Style -->
                <div class="p5-col-left">
                    <div class="proposal-section-2col">
                        <h3 class="result-title-center">ä¼¼åˆã†ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«</h3>
                        <div id="hairstyle-proposal" class="proposal-grid-list"></div>
                    </div>
                </div>

                <!-- Right Column: Hair Color -->
                <div class="p5-col-right">
                    <div class="proposal-section-2col shadow-inner">
                        <h3 class="result-title-center">ä¼¼åˆã†ãƒ˜ã‚¢ã‚«ãƒ©ãƒ¼</h3>
                        <div id="haircolor-proposal" class="proposal-grid-list"></div>
                    </div>
                </div>

                <div class="p5-footer-2col">
                    <button id="back-to-diagnosis-btn" class="btn-outline-2col">æˆ»ã‚‹</button>
                    <button id="save-phase5-btn" class="btn-outline-2col">ç”»åƒä¿å­˜</button>
                    <button id="next-to-phase5-2-btn" class="btn-outline-2col">ã‚¢ãƒ‰ãƒã‚¤ã‚¹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 5-2: AI Looks good Advice (Others Focused - 2 Columns) -->
    <div id="phase5-2" class="phase-container" style="display:none;">
        <div class="card landscape-card no-scroll-container">
            <div class="p5-layout-2col">
                <div class="p5-header">
                    <h2 class="form-title-center">AI Looks good Advice</h2>
                </div>

                <!-- Left Column: Makeup & Fashion -->
                <div class="p5-col-left">
                    <div class="proposal-section-2col">
                        <h3 class="result-title-center">ä¼¼åˆã†ãƒ¡ã‚¤ã‚¯</h3>
                        <div id="makeup-proposal" class="proposal-grid-list"></div>
                    </div>
                    <div class="proposal-section-2col" style="margin-top: 2vh;">
                        <h3 class="result-title-center">ä¼¼åˆã†ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³</h3>
                        <div id="fashion-proposal" class="proposal-grid-list"></div>
                    </div>
                </div>

                <!-- Right Column: Best Colors & Advice -->
                <div class="p5-col-right">
                    <div class="proposal-section-2col">
                        <h3 class="result-title-center">ç›¸æ€§ãƒ™ã‚¹ãƒˆã‚«ãƒ©ãƒ¼</h3>
                        <div id="best-colors-proposal" class="best-colors-row"></div>
                    </div>
                    <div class="proposal-section-2col" style="margin-top: 2vh;">
                        <h3 class="result-title-center">AIã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
                        <div class="stylist-advice-container">
                            <p id="top-stylist-comment-text"></p>
                        </div>
                    </div>
                </div>

                <div class="p5-footer-2col">
                    <button id="back-to-phase5-btn" class="btn-outline-2col">æˆ»ã‚‹</button>
                    <button id="save-phase5-2-btn" class="btn-outline-2col">ç”»åƒä¿å­˜</button>
                    <button id="move-to-phase6-btn" class="btn-outline-2col">åˆæˆç”»åƒã‚’ç”Ÿæˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 6: Generated Image (Style Selection) -->
    <div id="phase6" class="container-fluid phase-container" style="display:none;">
        <div class="phase-header">
            <h2 class="phase-title">Style Selection</h2>
        </div>

        <div class="phase6-layout-grid">
            <!-- Col 1: Style List -->
            <div class="p6-col-style">
                <h3 class="refinement-title"><img src="images/AIç¾å®¹å¸«.png" alt="" class="proposal-icon"> ã‚¹ã‚¿ã‚¤ãƒ«</h3>
                <div id="style-selection-group" class="form-group scroll-y"></div>
            </div>
            <!-- Col 2: Color List -->
            <div class="p6-col-color">
                <h3 class="refinement-title"><img src="images/ãƒ˜ã‚¢ã‚«ãƒ©ãƒ¼.png" alt="" class="proposal-icon"> ã‚«ãƒ©ãƒ¼</h3>
                <div id="color-selection-group" class="form-group scroll-y"></div>
            </div>
            <!-- Col 3: Tone & Start -->
            <div class="p6-col-action">
                <h3 class="refinement-title"><img src="images/ãƒ˜ã‚¢ã‚«ãƒ©ãƒ¼.png" alt="" class="proposal-icon"> æ˜ã‚‹ã•</h3>
                <div class="form-group">
                    <select id="hair-tone-select" class="form-control">
                        <option value="">ç¾åœ¨ã®é«ªè‰²</option>
                        <option value="Tone 5">Tone 5</option>
                        <option value="Tone 7">Tone 7</option>
                        <option value="Tone 9">Tone 9</option>
                        <option value="Tone 11">Tone 11</option>
                        <option value="Tone 13">Tone 13</option>
                        <option value="Tone 15">Tone 15</option>
                        <option value="Tone 18">Tone 18</option>
                    </select>
                </div>
                <div class="phase6-bottom-buttons">
                    <button id="back-to-proposal-btn-p6" class="btn-secondary">æˆ»ã‚‹</button>
                    <button id="generate-image-btn" class="btn-primary">Composite START</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PHASE 7: Refinement (Composite) -->
    <div id="phase7" class="container-fluid phase-container" style="display:none;">
        <div class="phase-header">
            <h2 class="phase-title">Refinement</h2>
        </div>

        <div class="phase7-layout">
            <!-- Left: Controls -->
            <div id="phase7-adjustment-container" class="p7-comp-left">
                <!-- Debug Status for iPad -->
                <div id="segmentation-status" style="display:none !important;">Ready
                </div>
                <div class="adjustment-controls horizontal-faders">
                    <!-- Brightness -->
                    <div class="fader-container">
                        <div class="fader-title">Brightness <span id="label-brightness-val"
                                style="font-weight:normal; margin-left:5px;">(10tone)</span></div>
                        <div class="control-item fader-group">
                            <span class="fader-icon">ğŸ’¡</span>
                            <button class="fader-btn-down" data-target="range-brightness" data-step="-1">â—€</button>
                            <input type="range" id="range-brightness" min="5" max="20" value="10"
                                class="horizontal-fader">
                            <button class="fader-btn-up" data-target="range-brightness" data-step="1">â–¶</button>
                        </div>
                    </div>

                    <!-- Hue -->
                    <div class="fader-container">
                        <div class="fader-title">Hue <span id="label-hue-val"
                                style="font-weight:normal; margin-left:5px;">(180Â°)</span></div>
                        <div class="control-item fader-group">
                            <span class="fader-icon">ğŸ¨</span>
                            <button class="fader-btn-down" data-target="range-hue" data-step="-10">â—€</button>
                            <input type="range" id="range-hue" min="0" max="360" value="180" class="horizontal-fader">
                            <button class="fader-btn-up" data-target="range-hue" data-step="10">â–¶</button>
                        </div>
                    </div>

                    <!-- Saturate -->
                    <div class="fader-container">
                        <div class="fader-title">Saturation <span id="label-saturate-val"
                                style="font-weight:normal; margin-left:5px;">(0%)</span></div>
                        <div class="control-item fader-group">
                            <span class="fader-icon">ğŸ’§</span>
                            <button class="fader-btn-down" data-target="range-saturate" data-step="-10">â—€</button>
                            <input type="range" id="range-saturate" min="0" max="100" value="0"
                                class="horizontal-fader">
                            <button class="fader-btn-up" data-target="range-saturate" data-step="10">â–¶</button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right: Image -->
            <div class="p7-comp-right">
                <div class="image-preview-wrapper">
                    <img id="main-diagnosis-image" src="" alt="Diagnosis Result" style="display:none;"
                        crossorigin="anonymous">
                    <canvas id="phase6-canvas"></canvas>
                </div>
            </div>

            <!-- Buttons Area (Moved to root for easier layout) -->
            <div class="comp-buttons-area">
                <div class="save-buttons-group">
                    <button id="btn-back-style" class="btn-outline">Styleã«æˆ»ã‚‹</button>
                    <button id="btn-save" class="btn-primary">ä¿å­˜</button>
                    <button id="btn-reset" class="btn-dark-outline">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
                <!-- Hidden but kept if ref needed logic -->
                <button id="save-generated-image-to-db-btn" class="btn-success" style="display:none;">DBä¿å­˜</button>
                <button id="back-to-proposal-btn" class="btn-outline" style="display:none;">ææ¡ˆã«æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« (å…±é€š) -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">ãŠçŸ¥ã‚‰ã›</h3>
            </div>
            <div class="modal-body">
                <p id="modal-message"></p>
            </div>
            <div class="modal-footer">
                <button id="modal-ok-btn" class="btn-primary modal-btn">OK</button>
            </div>
        </div>
    </div>

    <!-- MediaPipe Vision (Global Bundle) -->
    <!-- MediaPipe Vision (ESM Import) -->
    <script type="module">
        import { FilesetResolver, ImageSegmenter } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/+esm";
        window.MediaPipeVision = { FilesetResolver, ImageSegmenter };
    </script>

    <script src="js/main.js?v=6" type="module"></script>
</body>

</html>