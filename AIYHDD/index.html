<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>AIトップスタイリスト診断</title><!-- Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script><!-- Google Fonts --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet"><!-- Ionicons --><script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script><script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script><!-- LINE LIFF SDK -->
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<!-- Firebase SDK (v9以降のModular SDKを推奨) -->
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

<style>
    body {
        font-family: 'Noto Sans JP', sans-serif;
    }

    .spinner {
        border-top-color: transparent;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
</head><body class="bg-gray-50 flex items-center justify-center min-h-screen p-4"><main id="app-container"
    class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg text-gray-800 p-8 transition-all duration-500">

    <!-- Screen: Loading -->
    <div id="loading-screen">
        <div class="flex flex-col items-center justify-center py-10">
            <div class="spinner w-12 h-12 border-4 border-teal-500 rounded-full mb-4"></div>
            <p class="text-gray-500">LIFFを初期化しています...</p>
        </div>
    </div>

    <!-- Screen: Welcome -->
    <div id="welcome-screen" class="hidden text-center">
        <h1 class="text-3xl font-bold text-teal-600 mb-2">AIトップスタイリスト</h1>
        <p class="text-gray-600 mb-8">AIがあなたの魅力を最大限に引き出すスタイルを診断・提案します。</p>
        <div class="space-y-4">
            <div class="p-4 bg-teal-50 rounded-lg">
                <h2 class="font-bold text-lg mb-2">① 多角的診断</h2>
                <p class="text-sm text-gray-700">顔、骨格、パーソナルカラーを写真と動画から総合的に分析します。</p>
            </div>
            <div class="p-4 bg-teal-50 rounded-lg">
                <h2 class="font-bold text-lg mb-2">② AIによる提案</h2>
                <p class="text-sm text-gray-700">診断結果に基づき、あなたに似合うヘアスタイルやカラーを具体的に提案します。</p>
            </div>
            <div class="p-4 bg-teal-50 rounded-lg">
                <h2 class="font-bold text-lg mb-2">③ バーチャル試着</h2>
                <p class="text-sm text-gray-700">提案されたスタイルをあなたの顔写真に合成し、仕上がりイメージを確認できます。</p>
            </div>
        </div>
        <button id="start-diagnosis-button"
            class="w-full mt-8 bg-teal-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-teal-600 transition">
            診断を開始する
        </button>
    </div>

    <!-- Screen: Capture -->
    <div id="capture-screen" class="hidden">
        <h2 class="text-2xl font-bold text-center mb-6">写真・動画の撮影</h2>
        <div class="space-y-4">
            <!-- Front Photo -->
            <div class="p-4 border rounded-lg flex items-center justify-between">
                <div>
                    <p class="font-bold">写真：正面 <span class="text-red-500">*</span></p>
                    <p class="text-sm text-gray-500">顔全体が写るように</p>
                </div>
                <label class="cursor-pointer">
                    <ion-icon name="camera" class="text-3xl text-teal-500"></ion-icon>
                    <input type="file" id="front-photo-input" class="hidden" accept="image/*" capture="user">
                </label>
            </div>
            <!-- Side Photo -->
            <div class="p-4 border rounded-lg flex items-center justify-between">
                <div>
                    <p class="font-bold">写真：側面</p>
                    <p class="text-sm text-gray-500">横顔と髪の長さがわかるように</p>
                </div>
                <label class="cursor-pointer">
                    <ion-icon name="camera" class="text-3xl text-teal-500"></ion-icon>
                    <input type="file" id="side-photo-input" class="hidden" accept="image/*" capture="user">
                </label>
            </div>
            <!-- Back Photo -->
            <div class="p-4 border rounded-lg flex items-center justify-between">
                <div>
                    <p class="font-bold">写真：背面</p>
                    <p class="text-sm text-gray-500">後ろ髪全体がわかるように</p>
                </div>
                <label class="cursor-pointer">
                    <ion-icon name="camera" class="text-3xl text-teal-500"></ion-icon>
                    <input type="file" id="back-photo-input" class="hidden" accept="image/*" capture="environment">
                </label>
            </div>
            <!-- Front Video -->
            <div class="p-4 border rounded-lg flex items-center justify-between">
                <div>
                    <p class="font-bold">動画：正面</p>
                    <p class="text-sm text-gray-500">ゆっくり左右に顔を動かす</p>
                </div>
                <label class="cursor-pointer">
                    <ion-icon name="videocam" class="text-3xl text-teal-500"></ion-icon>
                    <input type="file" id="front-video-input" class="hidden" accept="video/*" capture="user">
                </label>
            </div>
        </div>
        <button id="submit-button"
            class="w-full mt-8 bg-gray-400 text-white font-bold py-3 px-6 rounded-lg transition" disabled>
            AI診断をリクエスト
        </button>
    </div>

    <!-- Screen: Analyzing -->
    <div id="analyzing-screen" class="hidden text-center">
        <div class="flex flex-col items-center justify-center py-10">
            <div class="spinner w-12 h-12 border-4 border-teal-500 rounded-full mb-4"></div>
            <h2 class="text-2xl font-bold mb-2">AIが診断中です...</h2>
            <p class="text-gray-600">最大で1分ほどかかることがあります</p>
        </div>
    </div>

    <!-- Screen: Results -->
    <div id="results-screen" class="hidden">
        <h2 class="text-2xl font-bold text-center mb-6">AI診断結果</h2>
        <div id="results-content" class="space-y-6"></div>

        <h3 class="text-xl font-bold mt-8 mb-4 text-center">バーチャル試着</h3>
        <div class="bg-gray-100 p-4 rounded-lg">
            <img id="generated-image" src="https://placehold.co/600x400/EFEFEF/333333?text=ここに合成画像が表示されます"
                class="rounded-md w-full mb-4">
            <div id="style-buttons" class="grid grid-cols-2 gap-2"></div>
            <div class="mt-4">
                <p class="font-bold mb-2">微調整リクエスト:</p>
                <div class="flex gap-2">
                    <input type="text" id="adjustment-prompt" placeholder="例：もう少し明るく"
                        class="w-full p-2 border rounded-md">
                    <button id="adjust-button"
                        class="bg-gray-800 text-white font-bold px-4 rounded-md hover:bg-gray-700">送信</button>
                </div>
            </div>
        </div>
        <button id="restart-button"
            class="w-full mt-8 bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition">
            最初からやり直す
        </button>
    </div>

</main>

<script>
    // ======================================================================
    // 設定値
    // ======================================================================
    const LIFF_ID = '2008029428-DZNnAbNl';
    // ★★★ バックエンドのURLを修正 ★★★
    // API GatewayやCloud RunのURLを指定します。
    // 末尾にスラッシュは含めないでください。
    const BACKEND_URL = 'https://ai-top-stylist-backend-757347798313.asia-northeast1.run.app';
    const firebaseConfig = {
        apiKey: "AIzaSyD7f_GTwM7ee6AgMjwCRetyMNlVKDpb3_4",
        authDomain: "yhd-ai.firebaseapp.com",
        projectId: "yhd-ai",
        storageBucket: "yhd-ai.firebasestorage.app",
        messagingSenderId: "757347798313",
        appId: "1:757347798313:web:e64c91b4e8b0e8bfc33b38",
        measurementId: "G-D26PT4FYPR"
    };

    // ======================================================================
    // 要素の参照
    // ======================================================================
    const screens = {
        loading: document.getElementById('loading-screen'),
        welcome: document.getElementById('welcome-screen'),
        capture: document.getElementById('capture-screen'),
        analyzing: document.getElementById('analyzing-screen'),
        results: document.getElementById('results-screen'),
    };

    const buttons = {
        startDiagnosis: document.getElementById('start-diagnosis-button'),
        submit: document.getElementById('submit-button'),
        adjust: document.getElementById('adjust-button'),
        restart: document.getElementById('restart-button'),
    };

    const inputs = {
        frontPhoto: document.getElementById('front-photo-input'),
        sidePhoto: document.getElementById('side-photo-input'),
        backPhoto: document.getElementById('back-photo-input'),
        frontVideo: document.getElementById('front-video-input'),
    };

    const resultsContent = document.getElementById('results-content');
    const generatedImage = document.getElementById('generated-image');
    const styleButtonsContainer = document.getElementById('style-buttons');
    const adjustmentPromptInput = document.getElementById('adjustment-prompt');

    // ======================================================================
    // 状態管理
    // ======================================================================
    const uploadedFiles = {};
    let diagnosisData = null; // 診断結果を保持

    // ======================================================================
    // 関数
    // ======================================================================
    function switchScreen(screenName) {
        Object.values(screens).forEach(screen => screen.classList.add('hidden'));
        if (screens[screenName]) {
            screens[screenName].classList.remove('hidden');
        }
    }

    function checkAllFilesUploaded() {
        // 正面写真が必須であることをチェック
        if (uploadedFiles['frontPhoto']) {
            buttons.submit.disabled = false;
            buttons.submit.classList.replace('bg-gray-400', 'bg-teal-500');
        } else {
             buttons.submit.disabled = true;
            buttons.submit.classList.replace('bg-teal-500', 'bg-gray-400');
        }
    }

    function handleFileUpload(event, key) {
        const file = event.target.files[0];
        if (!file) return;

        uploadedFiles[key] = file;
        const icon = event.target.parentElement.querySelector('ion-icon');
        icon.classList.remove('text-teal-500');
        icon.classList.add('text-green-500');
        icon.setAttribute('name', 'checkmark-circle');

        checkAllFilesUploaded();
    }

    async function submitForDiagnosis() {
        if (!uploadedFiles.frontPhoto) {
            alert('必須項目である正面の写真をアップロードしてください。');
            return;
        }
        switchScreen('analyzing');

        const formData = new FormData();
        // FormDataにファイルを追加
        Object.keys(uploadedFiles).forEach(key => {
            if(uploadedFiles[key]){
                // 'front_photo' のように、Pythonバックエンドが期待するキーに変換
                const snakeCaseKey = key.replace(/([A-Z])/g, "_$1").toLowerCase();
                formData.append(snakeCaseKey, uploadedFiles[key]);
            }
        });
        
        try {
            const response = await fetch(`${BACKEND_URL}/api/diagnose`, {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                // エラーレスポンスがJSON形式でない場合も考慮
                let errorText = `診断サーバーでエラーが発生しました (HTTP ${response.status})。`;
                try {
                    const errorData = await response.json();
                    errorText = errorData.error || errorText;
                } catch (e) {
                     errorText = await response.text();
                }
                throw new Error(errorText);
            }

            diagnosisData = await response.json();
            displayResults(diagnosisData);
            switchScreen('results');

        } catch (error) {
            console.error('診断リクエストエラー:', error);
            alert(`エラーが発生しました: ${error.message}`);
            switchScreen('capture'); // エラー時は撮影画面に戻る
        }
    }

    function displayResults(data) {
        resultsContent.innerHTML = ''; // 結果表示エリアをクリア

        const { analysisResult, aiProposals } = data;

        let contentHtml = '<div class="bg-gray-100 p-4 rounded-lg space-y-2">';
        contentHtml += `<h3 class="font-bold text-lg">あなたの特徴</h3>`;
        contentHtml += `<p><strong>顔の形:</strong> ${analysisResult.face_shape || 'N/A'}</p>`;
        contentHtml += `<p><strong>パーソナルカラー:</strong> ${analysisResult.season || 'N/A'} (${analysisResult.base_color || 'N/A'})</p>`;
        contentHtml += `<p><strong>肩のライン:</strong> ${analysisResult.shoulder_line || 'N/A'}</p>`;
        contentHtml += '</div>';

        contentHtml += '<div class="bg-gray-100 p-4 rounded-lg space-y-2">';
        contentHtml += `<h3 class="font-bold text-lg">AIからの総合コメント</h3>`;
        contentHtml += `<p>${aiProposals.summary || 'コメントはありません。'}</p>`;
        contentHtml += '</div>';

        resultsContent.innerHTML = contentHtml;

        styleButtonsContainer.innerHTML = '';
        aiProposals.hairstyleProposals.forEach(style => {
            const button = document.createElement('button');
            button.className = 'w-full p-2 bg-teal-500 text-white text-sm rounded-md hover:bg-teal-600';
            button.textContent = style.name;
            button.onclick = () => generateStyleImage(style.name);
            styleButtonsContainer.appendChild(button);
        });
    }

    async function generateStyleImage(prompt) {
        generatedImage.src = "https://placehold.co/600x400/EFEFEF/333333?text=画像を生成中です...";

        const formData = new FormData();
        formData.append('front_photo', uploadedFiles.frontPhoto);
        formData.append('prompt', prompt);

        try {
            const response = await fetch(`${BACKEND_URL}/api/generate_style`, {
                method: 'POST',
                body: formData,
            });

            if (!response.ok) {
                 let errorText = `画像生成に失敗しました (HTTP ${response.status})。`;
                 try {
                    const errorData = await response.json();
                    errorText = errorData.error || errorText;
                } catch (e) {
                     errorText = await response.text();
                }
                throw new Error(errorText);
            }

            const imageBlob = await response.blob();
            generatedImage.src = URL.createObjectURL(imageBlob);

        } catch (error) {
            console.error('画像生成エラー:', error);
            alert(error.message);
            generatedImage.src = "https://placehold.co/600x400/FFCDD2/B71C1C?text=エラー";
        }
    }

    async function main() {
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('Firebase initialized.');
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                console.log('LIFF initialized. Profile:', profile);
                switchScreen('welcome');
            }
        } catch (err) {
            console.error('Initialization failed', err);
            alert('初期化に失敗しました。LINEアプリ内で開いているか確認してください。');
            screens.loading.innerHTML = '<p class="text-red-500">初期化に失敗しました</p>';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        main();
        buttons.startDiagnosis.addEventListener('click', () => switchScreen('capture'));
        buttons.submit.addEventListener('click', submitForDiagnosis);
        buttons.adjust.addEventListener('click', () => {
            const selectedStyle = diagnosisData?.aiProposals?.hairstyleProposals[0]?.name; // 最初の提案をベースにする
            const adjustmentText = adjustmentPromptInput.value;
            if (!selectedStyle) {
                alert("先に基本となるスタイルを生成してください。");
                return;
            }
            if (adjustmentText) {
                const fullPrompt = `${selectedStyle}、ただし「${adjustmentText}」のように変更`;
                generateStyleImage(fullPrompt);
            }
        });
        buttons.restart.addEventListener('click', () => window.location.reload());
        inputs.frontPhoto.addEventListener('change', (e) => handleFileUpload(e, 'frontPhoto'));
        inputs.sidePhoto.addEventListener('change', (e) => handleFileUpload(e, 'sidePhoto'));
        inputs.backPhoto.addEventListener('change', (e) => handleFileUpload(e, 'backPhoto'));
        inputs.frontVideo.addEventListener('change', (e) => handleFileUpload(e, 'frontVideo'));
    });
</script>
</body></html>