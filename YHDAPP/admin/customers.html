<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>顧客管理 - 管理画面</title>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root {
            --tiffany-blue: #0ABAB5;
            --azure-bg: #F0FFFF;
            --light-tiffany: #E6FFFA;
            --text-dark: #333;
        }
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--azure-bg);
            color: var(--text-dark);
        }
        .bg-tiffany { background-color: var(--tiffany-blue); }
        .text-tiffany { color: var(--tiffany-blue); }
        .border-tiffany { border-color: var(--tiffany-blue); }
        .btn-primary {
            background-color: var(--tiffany-blue);
            color: white;
            transition: all 0.3s;
        }
        #image-viewer {
            transition: opacity 0.3s ease-in-out;
        }
        #image-viewer img {
            max-width: 90vw;
            max-height: 90vh;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-tiffany"></i>
            <p id="loading-message" class="mt-4 text-gray-600 font-bold">読み込み中...</p>
        </div>
    </div>

    <div id="app" class="max-w-lg mx-auto bg-white min-h-screen shadow-2xl" style="display: none;">
        <header class="bg-tiffany text-white p-4 flex items-center justify-between sticky top-0 z-20 shadow-md">
            <div class="w-1/4">
                <a href="./index.html" class="text-white"><i class="fas fa-chevron-left"></i> Menu</a>
            </div>
            <h1 class="w-1/2 text-xl font-bold tracking-wider text-center">顧客管理</h1>
            <div class="w-1/4"></div>
        </header>

        <main class="p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">顧客リスト</h2>
                <button id="add-new-customer-btn" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold"><i class="fas fa-user-plus mr-2"></i>新規顧客追加</button>
            </div>
            <div class="relative mb-4">
                <input type="text" id="customer-search" placeholder="顧客名・ふりがなで検索" class="w-full rounded-md border-gray-300 shadow-sm pl-10">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <div id="customer-list-container" class="space-y-4"></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="customer-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-30">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-lg">
            <h3 id="customer-modal-title" class="font-bold text-lg mb-4"></h3>
            <input type="hidden" id="editing-customer-id">
            
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-basic-info" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-tiffany text-tiffany">基本情報</button>
                    <button id="tab-visit-history" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">来店履歴</button>
                    <button id="tab-gallery" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">ギャラリー</button>
                </nav>
            </div>

            <div id="panel-basic-info" class="space-y-4 mt-4 max-h-[60vh] overflow-y-auto pr-2">
                 <div>
                    <label class="block text-sm font-medium">名前</label>
                    <input type="text" id="customer-modal-name" class="w-full mt-1 rounded-md border-gray-300">
                </div>
                <div>
                    <label class="block text-sm font-medium">ふりがな</label>
                    <input type="text" id="customer-modal-furigana" class="w-full mt-1 rounded-md border-gray-300">
                </div>
                 <div>
                    <label class="block text-sm font-medium">LINE ID (表示名)</label>
                    <input type="text" id="customer-modal-line-display-name" class="w-full mt-1 rounded-md border-gray-300">
                </div>
                 <div>
                    <label class="block text-sm font-medium">LINE User ID</label>
                    <input type="text" id="customer-modal-line-user-id" readonly class="w-full mt-1 rounded-md border-gray-300 bg-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium">電話番号</label>
                    <input type="tel" id="customer-modal-phone" class="w-full mt-1 rounded-md border-gray-300">
                </div>
                <div>
                    <label class="block text-sm font-medium">注意事項</label>
                    <textarea id="customer-modal-precautions" rows="3" class="w-full mt-1 rounded-md border-gray-300" placeholder="注意事項がある場合に記入します"></textarea>
                </div>
            </div>
            
            <div id="panel-visit-history" class="hidden mt-4 max-h-[60vh] overflow-y-auto pr-2"></div>
            <div id="panel-gallery" class="hidden mt-4 max-h-[60vh] overflow-y-auto pr-2"></div>

            <div class="mt-6 flex justify-end gap-3">
                <button id="customer-modal-close-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-bold">閉じる</button>
                <button id="customer-modal-save-btn" class="btn-primary px-4 py-2 rounded-lg font-bold">保存</button>
            </div>
        </div>
    </div>

    <div id="image-viewer" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40 hidden opacity-0" onclick="this.classList.add('opacity-0'); setTimeout(() => this.classList.add('hidden'), 300)">
        <img id="fullscreen-image" src="" alt="拡大画像" class="rounded-lg shadow-2xl">
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, OAuthProvider, signInWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, addDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCD5M3LIs8YPPeQlBecnLi9iaxy2Sco-pI",
                authDomain: "yhddatebase.firebaseapp.com",
                projectId: "yhddatebase",
                storageBucket: "yhddatebase.appspot.com",
                messagingSenderId: "908640006259",
                appId: "1:908640006259:web:f1af7804cf7316ef057a06"
            };
            const ADMIN_LIFF_ID = "2008029428-ANbgw3b6";

            const fbApp = initializeApp(firebaseConfig);
            const auth = getAuth(fbApp);
            const db = getFirestore(fbApp);
            const storage = getStorage(fbApp);
            const appId = fbApp.options.projectId;

            const loadingMessage = document.getElementById('loading-message');
            let isAppInitialized = false;

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    if (!isAppInitialized) {
                        initializeAppUI(user);
                    }
                } else {
                    adminLiffLogin();
                }
            });

            async function adminLiffLogin() {
                if (!ADMIN_LIFF_ID || ADMIN_LIFF_ID === "YOUR_ADMIN_LIFF_ID") {
                    loadingMessage.textContent = '管理者用LIFF IDが設定されていません。';
                    return;
                }
                try {
                    await liff.init({ liffId: ADMIN_LIFF_ID });
                    if (!liff.isLoggedIn()) {
                        liff.login({ redirectUri: window.location.href });
                        return;
                    }
                    const idToken = liff.getIDToken();
                    const provider = new OAuthProvider('oidc.line');
                    const credential = provider.credential({ idToken });
                    await signInWithCredential(auth, credential);
                } catch (error) {
                    loadingMessage.textContent = `エラー: ${error.message}`;
                }
            }

            async function initializeAppUI(firebaseUser) {
                const adminRef = doc(db, `admins/${firebaseUser.uid}`);
                const adminDoc = await getDoc(adminRef);
                if (!adminDoc.exists()) {
                    loadingMessage.textContent = "エラー: 管理者権限がありません。";
                    return;
                }
                
                isAppInitialized = true;
                await init();
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'block';
            }

            let customerData = [];
            let adminBookingData = {}; 

            const elements = {
                customerSearchInput: document.getElementById('customer-search'),
                customerListContainer: document.getElementById('customer-list-container'),
                customerModal: document.getElementById('customer-modal'),
                customerModalTitle: document.getElementById('customer-modal-title'),
                editingCustomerId: document.getElementById('editing-customer-id'),
                customerModalName: document.getElementById('customer-modal-name'),
                customerModalFurigana: document.getElementById('customer-modal-furigana'),
                customerModalLineDisplayName: document.getElementById('customer-modal-line-display-name'),
                customerModalLineUserId: document.getElementById('customer-modal-line-user-id'),
                customerModalPhone: document.getElementById('customer-modal-phone'),
                customerModalPrecautions: document.getElementById('customer-modal-precautions'),
                tabBasicInfo: document.getElementById('tab-basic-info'),
                tabVisitHistory: document.getElementById('tab-visit-history'),
                tabGallery: document.getElementById('tab-gallery'),
                panelBasicInfo: document.getElementById('panel-basic-info'),
                panelVisitHistory: document.getElementById('panel-visit-history'),
                panelGallery: document.getElementById('panel-gallery'),
                saveBtn: document.getElementById('customer-modal-save-btn'),
                imageViewer: document.getElementById('image-viewer'),
                fullscreenImage: document.getElementById('fullscreen-image'),
            };

            async function init() {
                setupRealtimeListeners();
                setupEventListeners();
            }

            function setupRealtimeListeners() {
                const customersCol = collection(db, `artifacts/${appId}/public/data/customers`);
                onSnapshot(customersCol, (snapshot) => {
                    customerData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCustomerList(elements.customerSearchInput.value);
                    const openCustomerId = elements.editingCustomerId.value;
                    if (openCustomerId && !elements.customerModal.classList.contains('hidden')) {
                        openCustomerModal(openCustomerId);
                    }
                }, (error) => {
                    console.error("顧客データのリアルタイム更新エラー:", error);
                });
                
                const bookingsCol = collection(db, `artifacts/${appId}/public/data/bookings`);
                onSnapshot(bookingsCol, (snapshot) => {
                    adminBookingData = {};
                    snapshot.docs.forEach(doc => {
                         const data = doc.data();
                         if (!adminBookingData[data.date]) adminBookingData[data.date] = [];
                         adminBookingData[data.date].push({ ...data, bookingDocId: doc.id });
                    });
                });
            }

            function renderCustomerList(filter = '') {
                const container = elements.customerListContainer;
                container.innerHTML = '';
                const filteredCustomers = customerData.filter(c => 
                    (c.name && c.name.toLowerCase().includes(filter.toLowerCase())) || 
                    (c.furigana && c.furigana.includes(filter))
                );

                if (filteredCustomers.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500">該当する顧客が見つかりません。</p>';
                    return;
                }

                const grouped = filteredCustomers
                    .sort((a, b) => (a.furigana || '').localeCompare(b.furigana || '', 'ja'))
                    .reduce((acc, customer) => {
                        const gyo = getGyo((customer.furigana || ' ').charAt(0));
                        if (!acc[gyo]) acc[gyo] = [];
                        acc[gyo].push(customer);
                        return acc;
                    }, {});

                Object.keys(grouped).sort((a, b) => a.localeCompare(b, 'ja')).forEach(gyo => {
                    const gyoDiv = document.createElement('div');
                    gyoDiv.innerHTML = `<h3 class="font-bold text-lg text-tiffany bg-gray-100 p-2 rounded-t-md">${gyo}</h3>`;
                    const list = document.createElement('ul');
                    list.className = 'border border-t-0 rounded-b-md p-2 space-y-2';
                    grouped[gyo].forEach(customer => {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center p-2 hover:bg-gray-50 rounded';
                        const lineIcon = customer.lineId ? `<i class="fab fa-line text-green-500 mr-2"></i>` : '';
                        const precautionsIcon = customer.precautions ? `<i class="fas fa-exclamation-triangle text-red-500 mr-2" title="注意事項あり"></i>` : '';
                        const visitCount = (customer.visitHistory || []).filter(v => v.transaction).length;
                        li.innerHTML = `
                            <div class="flex-1">
                                <p class="font-bold flex items-center">${precautionsIcon}${lineIcon}${customer.name} <span class="ml-2 text-xs bg-tiffany text-white px-2 py-0.5 rounded-full">${visitCount}回来店</span></p>
                                <p class="text-sm text-gray-500">${customer.furigana || ''}</p>
                            </div>
                            <div class="space-x-3 flex items-center">
                                <a href="../counseling/index.html?customerId=${customer.id}" class="text-green-500" title="カウンセリング"><i class="fas fa-clipboard fa-lg"></i></a>
                                <button class="text-gray-500 camera-btn" data-id="${customer.id}" title="カメラ起動"><i class="fas fa-camera fa-lg"></i></button>
                                <button class="text-blue-500 edit-customer-btn" data-id="${customer.id}" title="編集"><i class="fas fa-edit fa-lg"></i></button>
                                <button class="text-red-500 delete-customer-btn" data-id="${customer.id}" title="削除"><i class="fas fa-trash fa-lg"></i></button>
                            </div>
                        `;
                        list.appendChild(li);
                    });
                    gyoDiv.appendChild(list);
                    container.appendChild(gyoDiv);
                });
            }
            
            function getGyo(char) {
                const GYO_MAP = {'あ':'あ行','い':'あ行','う':'あ行','え':'あ行','お':'あ行','か':'か行','き':'か行','く':'か行','け':'か行','こ':'か行','さ':'さ行','し':'さ行','す':'さ行','せ':'さ行','そ':'さ行','た':'た行','ち':'た行','つ':'た行','て':'た行','と':'た行','な':'な行','に':'な行','ぬ':'な行','ね':'な行','の':'な行','は':'は行','ひ':'は行','ふ':'は行','へ':'は行','ほ':'は行','ま':'ま行','み':'ま行','む':'ま行','め':'ま行','も':'ま行','や':'や行','ゆ':'や行','よ':'や行','ら':'ら行','り':'ら行','る':'ら行','れ':'ら行','ろ':'ら行','わ':'わ行','を':'わ行','ん':'わ行',};
                return GYO_MAP[char] || 'その他';
            }

            function setupEventListeners() {
                document.getElementById('add-new-customer-btn').addEventListener('click', () => openCustomerModal());
                elements.customerSearchInput.addEventListener('input', (e) => renderCustomerList(e.target.value));
                elements.customerListContainer.addEventListener('click', handleCustomerListClick);
                elements.saveBtn.addEventListener('click', saveCustomer);
                document.getElementById('customer-modal-close-btn').addEventListener('click', () => elements.customerModal.classList.add('hidden'));

                elements.tabBasicInfo.addEventListener('click', () => switchTab('basic'));
                elements.tabVisitHistory.addEventListener('click', () => switchTab('history'));
                elements.tabGallery.addEventListener('click', () => switchTab('gallery'));
                elements.panelVisitHistory.addEventListener('click', handleVisitHistoryClick);
                elements.panelGallery.addEventListener('click', (e) => {
                    if (e.target.tagName === 'IMG') {
                        openImageViewer(e.target.src);
                    }
                });
            }
            
            function handleCustomerListClick(e) {
                const editBtn = e.target.closest('.edit-customer-btn');
                const deleteBtn = e.target.closest('.delete-customer-btn');
                const cameraBtn = e.target.closest('.camera-btn');
                if (editBtn) openCustomerModal(editBtn.dataset.id);
                if (deleteBtn) deleteCustomer(deleteBtn.dataset.id);
                if (cameraBtn) launchCamera(cameraBtn.dataset.id, cameraBtn);
            }
            
            function launchCamera(customerId, buttonElement) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment';

                input.onchange = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const icon = buttonElement.querySelector('i');
                    if (!icon) return; 

                    icon.classList.replace('fa-camera', 'fa-spinner');
                    icon.classList.add('fa-spin');

                    try {
                        const storageRef = ref(storage, `customer_photos/${customerId}/gallery/${Date.now()}_${file.name}`);
                        await uploadBytes(storageRef, file);
                        const downloadURL = await getDownloadURL(storageRef);
                        
                        await addImageToGallery(customerId, downloadURL);

                    } catch (error) {
                        console.error("写真のアップロードまたは保存中にエラー:", error);
                    } finally {
                       icon.classList.replace('fa-spinner', 'fa-camera');
                       icon.classList.remove('fa-spin');
                    }
                };
                input.click();
            }

            async function addImageToGallery(customerId, imageUrl) {
                const customerRef = doc(db, `artifacts/${appId}/public/data/customers`, customerId);
                const customerDoc = await getDoc(customerRef);
                if (!customerDoc.exists()) return;
                const customer = customerDoc.data();
                const gallery = customer.gallery || [];
                gallery.unshift({ url: imageUrl, date: new Date().toISOString().split('T')[0] });
                await updateDoc(customerRef, { gallery: gallery });
                alert('ギャラリーに写真を追加しました。');
            }

            function openCustomerModal(customerId = null) {
                const isEditing = customerId !== null;
                elements.customerModalTitle.textContent = isEditing ? '顧客情報の編集' : '新規顧客追加';
                elements.editingCustomerId.value = customerId || '';
                if (isEditing) {
                    const customer = customerData.find(c => c.id === customerId);
                    if (!customer) return;
                    elements.customerModalName.value = customer.name || '';
                    elements.customerModalFurigana.value = customer.furigana || '';
                    elements.customerModalLineDisplayName.value = customer.lineDisplayName || ''; // LINEの表示名
                    elements.customerModalLineUserId.value = customer.lineId || ''; // LINE User ID
                    elements.customerModalPhone.value = customer.phone || '';
                    elements.customerModalPrecautions.value = customer.precautions || '';
                    renderVisitHistory(customer.visitHistory || []);
                    renderGallery(customer.gallery || []);
                    [elements.tabVisitHistory, elements.tabGallery].forEach(t => t.classList.remove('hidden'));
                } else {
                    elements.customerModalName.value = '';
                    elements.customerModalFurigana.value = '';
                    elements.customerModalLineDisplayName.value = '';
                    elements.customerModalLineUserId.value = '(新規登録時に自動採番)';
                    elements.customerModalPhone.value = '';
                    elements.customerModalPrecautions.value = '';
                    [elements.tabVisitHistory, elements.tabGallery].forEach(t => t.classList.add('hidden'));
                }
                switchTab('basic');
                elements.customerModal.classList.remove('hidden');
            }

            async function saveCustomer() {
                const customerId = elements.editingCustomerId.value;
                const newCustomerData = {
                    name: elements.customerModalName.value.trim(),
                    furigana: elements.customerModalFurigana.value.trim(),
                    lineDisplayName: elements.customerModalLineDisplayName.value.trim(),
                    phone: elements.customerModalPhone.value.trim(),
                    precautions: elements.customerModalPrecautions.value.trim(),
                };

                if (!newCustomerData.name) {
                    alert('名前は必須です。');
                    return;
                }

                try {
                    if (customerId) {
                        const customerRef = doc(db, `artifacts/${appId}/public/data/customers`, customerId);
                        await updateDoc(customerRef, newCustomerData);
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/customers`), {
                            ...newCustomerData,
                            visitHistory: [],
                            gallery: []
                        });
                    }
                    elements.customerModal.classList.add('hidden');
                } catch (error) {
                    console.error("顧客情報の保存中にエラー:", error);
                }
            }

            async function deleteCustomer(customerId) {
                if (confirm("本当にこの顧客情報を削除しますか？\n関連する予約情報は削除されませんが、顧客との紐付けが解除されます。")) {
                    try {
                        const customerRef = doc(db, `artifacts/${appId}/public/data/customers`, customerId);
                        await deleteDoc(customerRef);
                    } catch (error) {
                        console.error("顧客情報の削除中にエラー:", error);
                    }
                }
            }
            
            function switchTab(tabName) {
                const tabs = {
                    basic: { btn: elements.tabBasicInfo, panel: elements.panelBasicInfo },
                    history: { btn: elements.tabVisitHistory, panel: elements.panelVisitHistory },
                    gallery: { btn: elements.tabGallery, panel: elements.panelGallery }
                };
                
                Object.values(tabs).forEach(tab => {
                    const isNewCustomer = elements.tabVisitHistory.classList.contains('hidden');
                    const baseClasses = 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm';
                    const activeClasses = `${baseClasses} border-tiffany text-tiffany`;
                    const inactiveClasses = `${baseClasses} border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300`;

                    if (tab.btn.id.includes(tabName)) {
                        tab.panel.classList.remove('hidden');
                        tab.btn.className = activeClasses;
                    } else {
                        tab.panel.classList.add('hidden');
                        if (!isNewCustomer || tab.btn.id.includes('basic')) {
                            tab.btn.className = inactiveClasses;
                        }
                    }
                });
                elements.saveBtn.style.display = (tabName === 'basic') ? 'block' : 'none';
            }

            function renderVisitHistory(history) {
                const container = elements.panelVisitHistory;
                container.innerHTML = '';
                const completedVisits = (history || []).filter(v => v.transaction);
                if (completedVisits.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 p-4">会計済みの来店履歴はありません。</p>';
                    return;
                }

                completedVisits.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((visit, index) => {
                    const visitDiv = document.createElement('div');
                    visitDiv.className = 'border rounded-md mb-3';
                    const header = document.createElement('button');
                    header.className = 'w-full text-left p-3 bg-gray-50 font-bold flex justify-between items-center';
                    header.innerHTML = `<span>${visit.date}</span><i class="fas fa-chevron-down transition-transform"></i>`;
                    
                    const content = document.createElement('div');
                    content.className = 'p-3 space-y-3 hidden';
                    
                    let contentHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-500">メモ (お客様に表示)</label>
                            <textarea class="w-full mt-1 rounded-md border-gray-300" data-visit-index="${index}" data-memo-type="memo">${visit.memo || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-500">スタッフメモ (管理者のみ)</label>
                            <textarea class="w-full mt-1 rounded-md border-gray-300" data-visit-index="${index}" data-memo-type="staffMemo">${visit.staffMemo || ''}</textarea>
                        </div>
                        <button class="text-sm btn-primary px-3 py-1 rounded-md save-memo-btn" data-visit-index="${index}">メモを保存</button>
                    `;
                    
                    if(visit.transaction) {
                        const bookingDocId = findBookingDocIdByTransaction(visit.transaction.transactionId);
                        contentHTML += `<div class="border-t pt-3 mt-3">
                            <h4 class="font-semibold text-sm mb-1 text-tiffany">会計詳細</h4>
                            <div class="text-sm">
                                ${visit.transaction.items.map(item => `<div class="flex justify-between"><span>${item.name}</span><span>¥${item.price.toLocaleString()}</span></div>`).join('')}
                                <hr class="my-1">
                                <div class="flex justify-between font-bold"><span>合計</span><span>¥${visit.transaction.total.toLocaleString()}</span></div>
                            </div>
                            <div class="mt-2 flex gap-2 justify-end">
                                <button class="text-sm bg-blue-500 text-white px-3 py-1 rounded-md edit-transaction-btn" data-booking-doc-id="${bookingDocId || ''}">変更</button>
                                <button class="text-sm bg-red-500 text-white px-3 py-1 rounded-md delete-transaction-btn" data-visit-index="${index}" data-booking-doc-id="${bookingDocId || ''}">削除</button>
                            </div>
                        </div>`;
                    }

                    content.innerHTML = contentHTML;
                    
                    header.addEventListener('click', () => {
                        content.classList.toggle('hidden');
                        header.querySelector('i').classList.toggle('rotate-180');
                    });

                    visitDiv.appendChild(header);
                    visitDiv.appendChild(content);
                    container.appendChild(visitDiv);
                });
            }
            
            function findBookingDocIdByTransaction(transactionId) {
                for (const date in adminBookingData) {
                    const bookingsOnDate = adminBookingData[date];
                    const booking = bookingsOnDate.find(b => b.transactionDetails?.transactionId === transactionId);
                    if (booking) return booking.bookingDocId;
                }
                return null;
            }

            function renderGallery(gallery) {
                const container = elements.panelGallery;
                container.innerHTML = '';
                if (!gallery || gallery.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 p-4">ギャラリーに写真はありません。</p>';
                    return;
                }
                const groupedByDate = gallery.reduce((acc, photo) => {
                    const date = photo.date || '日付不明';
                    if (!acc[date]) acc[date] = [];
                    acc[date].push(photo.url);
                    return acc;
                }, {});

                Object.keys(groupedByDate).sort((a,b) => new Date(b) - new Date(a)).forEach(date => {
                    container.innerHTML += `
                        <div class="mb-4">
                            <h4 class="font-bold text-sm text-gray-500 mb-2">${date}</h4>
                            <div class="grid grid-cols-3 gap-2">
                                ${groupedByDate[date].map(url => `<img src="${url}" class="rounded border w-full h-24 object-cover cursor-pointer gallery-image">`).join('')}
                            </div>
                        </div>
                    `;
                });
            }

            async function saveVisitMemos(visitIndex) {
                 const customerId = elements.editingCustomerId.value;
                 const customer = customerData.find(c => c.id === customerId);
                 if (!customer) return;

                 const memoInput = document.querySelector(`textarea[data-visit-index="${visitIndex}"][data-memo-type="memo"]`);
                 const staffMemoInput = document.querySelector(`textarea[data-visit-index="${visitIndex}"][data-memo-type="staffMemo"]`);
                 
                 customer.visitHistory[visitIndex].memo = memoInput.value;
                 customer.visitHistory[visitIndex].staffMemo = staffMemoInput.value;
                 
                 const customerRef = doc(db, `artifacts/${appId}/public/data/customers`, customerId);
                 await updateDoc(customerRef, { visitHistory: customer.visitHistory });
                 alert('メモを保存しました。');
            }
            
            async function deleteTransaction(visitIndex, bookingDocId) {
                if (!confirm("この会計情報を取り消しますか？予約は「会計待ち」の状態に戻ります。")) return;
                
                const customerId = elements.editingCustomerId.value;
                const customerRef = doc(db, `artifacts/${appId}/public/data/customers`, customerId);
                const customerDoc = await getDoc(customerRef);
                if (!customerDoc.exists()) return;

                const customer = customerDoc.data();
                customer.visitHistory.splice(visitIndex, 1);
                
                const bookingRef = doc(db, `artifacts/${appId}/public/data/bookings`, bookingDocId);
                
                await updateDoc(customerRef, { visitHistory: customer.visitHistory });
                await updateDoc(bookingRef, { status: 'booked', transactionDetails: null });
                
                alert('会計を取り消しました。');
            }

            function handleVisitHistoryClick(e) {
                const saveBtn = e.target.closest('.save-memo-btn');
                const editBtn = e.target.closest('.edit-transaction-btn');
                const deleteBtn = e.target.closest('.delete-transaction-btn');

                if (saveBtn) saveVisitMemos(parseInt(saveBtn.dataset.visitIndex));
                if (editBtn) window.location.href = `./pos.html?bookingDocId=${editBtn.dataset.bookingDocId}`;
                if (deleteBtn) deleteTransaction(parseInt(deleteBtn.dataset.visitIndex), deleteBtn.dataset.bookingDocId);
            }

            function openImageViewer(src) {
                elements.fullscreenImage.src = src;
                elements.imageViewer.classList.remove('hidden');
                setTimeout(() => elements.imageViewer.classList.remove('opacity-0'), 10);
            }
            
            function handleUrlParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId');
                if (customerId) {
                    const customer = customerData.find(c => c.id === customerId);
                    if (customer) {
                        openCustomerModal(customerId);
                    }
                }
            }
        });
    </script>
</body>
</html>

