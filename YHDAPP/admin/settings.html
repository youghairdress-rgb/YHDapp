<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>サロン設定 - 管理画面</title>

        <!-- ▼▼▼ この3行を追加 ▼▼▼ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- ▲▲▲ この3行を追加 ▲▲▲ -->
     
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root {
            --tiffany-blue: #0ABAB5;
            --azure-bg: #F0FFFF;
            --text-dark: #333;
        }
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--azure-bg);
            color: var(--text-dark);
        }
        .bg-tiffany { background-color: var(--tiffany-blue); }
        .text-tiffany { color: var(--tiffany-blue); }
        .border-tiffany { border-color: var(--tiffany-blue); }
        .btn-primary {
            background-color: var(--tiffany-blue);
            color: white;
            transition: all 0.3s;
            box-shadow: 0 4px 14px 0 rgba(0, 171, 181, 0.39);
        }
        .btn-primary:hover {
            background-color: #089a94;
            box-shadow: 0 6px 20px 0 rgba(0, 171, 181, 0.23);
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-tiffany"></i>
            <p id="loading-message" class="mt-4 text-gray-600 font-bold">読み込み中...</p>
        </div>
    </div>

    <div id="app" class="max-w-lg mx-auto bg-white min-h-screen shadow-2xl" style="display: none;">
        <header class="bg-tiffany text-white p-4 flex items-center justify-between sticky top-0 z-20 shadow-md">
            <div class="w-1/4">
                <a href="./index.html" id="back-to-admin-menu" class="text-white"><i class="fas fa-chevron-left"></i> Menu</a>
            </div>
            <h1 id="header-title" class="w-1/2 text-xl font-bold tracking-wider text-center">サロン設定</h1>
            <div class="w-1/4"></div>
        </header>

        <main class="p-4 md:p-6">
            <div id="admin-settings-screen">
                 <div class="bg-white p-4 rounded-lg shadow-md mb-6 space-y-4">
                     <div>
                         <h3 class="font-bold text-lg mb-3 border-l-4 border-tiffany pl-2">営業時間設定</h3>
                         <div class="flex items-center gap-2">
                            <select id="opening-hour" class="w-full border-gray-300 rounded-md shadow-sm"></select>
                            <span>～</span>
                            <select id="closing-hour" class="w-full border-gray-300 rounded-md shadow-sm"></select>
                         </div>
                     </div>
                     <hr>
                     <div>
                         <h3 class="font-bold text-lg mb-3 border-l-4 border-tiffany pl-2">定休日設定</h3>
                         <div id="regular-holidays" class="grid grid-cols-4 gap-2 text-center">
                             <label class="p-2 border rounded-lg"><input type="checkbox" class="mr-2" value="1"> 月</label>
                             <label class="p-2 border rounded-lg"><input type="checkbox" class="mr-2" value="2"> 火</label>
                             <label class="p-2 border rounded-lg"><input type="checkbox" class="mr-2" value="3"> 水</label>
                             <label class="p-2 border rounded-lg"><input type="checkbox" class="mr-2" value="4"> 木</label>
                             <label class="p-2 border rounded-lg"><input type="checkbox" class="mr-2" value="5"> 金</label>
                             <label class="p-2 border rounded-lg"><input type="checkbox" class="mr-2" value="6"> 土</label>
                             <label class="p-2 border rounded-lg"><input type="checkbox" class="mr-2" value="0"> 日</label>
                         </div>
                     </div>
                     <hr>
                     <div>
                         <h3 class="font-bold text-lg mb-3 border-l-4 border-tiffany pl-2">特別休日設定</h3>
                         <div class="flex items-center gap-2 mb-3">
                             <input type="date" id="special-holiday-input" class="w-full border-gray-300 rounded-md shadow-sm">
                             <button id="add-special-holiday-btn" class="btn-primary px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap">追加</button>
                         </div>
                         <ul id="special-holidays-list" class="mt-2 space-y-2">
                         </ul>
                     </div>
                     <hr>
                     <div>
                         <h3 class="font-bold text-lg mb-3 border-l-4 border-tiffany pl-2">予約締切設定</h3>
                         <div class="flex items-center gap-2">
                             <span>予約の</span>
                             <input type="number" id="booking-deadline" class="w-20 text-center border-gray-300 rounded-md shadow-sm" value="60">
                             <span>分前まで受付</span>
                         </div>
                     </div>
                 </div>
                 <button id="save-settings-btn" class="w-full btn-primary py-3 rounded-lg font-bold text-lg">設定を保存</button>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, OAuthProvider, signInWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCD5M3LIs8YPPeQlBecnLi9iaxy2Sco-pI",
                authDomain: "yhddatebase.firebaseapp.com",
                projectId: "yhddatebase",
                storageBucket: "yhddatebase.appspot.com",
                messagingSenderId: "908640006259",
                appId: "1:908640006259:web:f1af7804cf7316ef057a06"
            };
            const ADMIN_LIFF_ID = "2008029428-ANbgw3b6";

            const fbApp = initializeApp(firebaseConfig);
            const auth = getAuth(fbApp);
            const db = getFirestore(fbApp);
            const appId = fbApp.options.projectId;

            const loadingMessage = document.getElementById('loading-message');
            let isAppInitialized = false;

            onAuthStateChanged(auth, (user) => {
                if(user) {
                    if(!isAppInitialized) {
                        initializeAppUI(user);
                    }
                } else {
                    adminLiffLogin();
                }
            });

            async function adminLiffLogin() {
                if (!ADMIN_LIFF_ID || ADMIN_LIFF_ID === "YOUR_ADMIN_LIFF_ID") {
                    loadingMessage.textContent = '管理者用LIFF IDが設定されていません。';
                    return;
                }
                try {
                    await liff.init({ liffId: ADMIN_LIFF_ID });
                    if (!liff.isLoggedIn()) {
                        liff.login({ redirectUri: window.location.href });
                        return;
                    }
                    const idToken = liff.getIDToken();
                    const provider = new OAuthProvider('oidc.line');
                    const credential = provider.credential({ idToken });
                    await signInWithCredential(auth, credential);
                } catch (error) {
                    loadingMessage.textContent = `エラー: ${error.message}`;
                }
            }
            
            async function initializeAppUI(firebaseUser) {
                const adminRef = doc(db, `admins/${firebaseUser.uid}`);
                const adminDoc = await getDoc(adminRef);
                if (!adminDoc.exists()) {
                    loadingMessage.textContent = "エラー: 管理者権限がありません。";
                    return;
                }
                
                isAppInitialized = true;
                await init();
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'block';
            }

            let salonSettings = {
                regularHolidays: [],
                specialHolidays: [],
                bookingDeadline: 60,
                openingHour: 10,
                closingHour: 20,
            };

            const elements = {
                openingHourSelect: document.getElementById('opening-hour'),
                closingHourSelect: document.getElementById('closing-hour'),
                regularHolidaysContainer: document.getElementById('regular-holidays'),
                specialHolidayInput: document.getElementById('special-holiday-input'),
                addSpecialHolidayBtn: document.getElementById('add-special-holiday-btn'),
                specialHolidaysList: document.getElementById('special-holidays-list'),
                bookingDeadlineInput: document.getElementById('booking-deadline'),
                saveSettingsBtn: document.getElementById('save-settings-btn'),
            };

            async function init() {
                populateTimeSelects();
                await loadSettingsFromFirebase();
                setupEventListeners();
            }
            
            async function loadSettingsFromFirebase() {
                const settingsRef = doc(db, `artifacts/${appId}/public/data/salonSettings`, "config");
                try {
                    const docSnap = await getDoc(settingsRef);
                    if (docSnap.exists()) {
                        salonSettings = { ...salonSettings, ...docSnap.data() };
                    }
                } catch (error) {
                    console.error("Firebaseからのデータ読み込みエラー:", error);
                }
                updateUI();
            }

            async function saveSettingsToFirebase() {
                const settingsRef = doc(db, `artifacts/${appId}/public/data/salonSettings`, "config");
                try {
                    await setDoc(settingsRef, salonSettings);
                    alert('設定を保存しました。');
                } catch (error) {
                    console.error("Firebaseへのデータ保存エラー:", error);
                    alert('設定の保存に失敗しました。');
                }
            }

            function populateTimeSelects() {
                let options = '';
                for (let i = 0; i < 24; i++) {
                    options += `<option value="${i}">${String(i).padStart(2, '0')}:00</option>`;
                }
                elements.openingHourSelect.innerHTML = options;
                elements.closingHourSelect.innerHTML = options;
            }

            function updateUI() {
                elements.openingHourSelect.value = salonSettings.openingHour;
                elements.closingHourSelect.value = salonSettings.closingHour;
                elements.regularHolidaysContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = (salonSettings.regularHolidays || []).includes(parseInt(checkbox.value));
                });
                elements.bookingDeadlineInput.value = salonSettings.bookingDeadline;
                renderSpecialHolidays();
            }

            function renderSpecialHolidays() {
                elements.specialHolidaysList.innerHTML = '';
                if (!salonSettings.specialHolidays) salonSettings.specialHolidays = [];
                salonSettings.specialHolidays.sort().forEach(date => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-md';
                    li.textContent = formatDate(date);
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-red-500 hover:text-red-700';
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteBtn.dataset.date = date;
                    
                    li.appendChild(deleteBtn);
                    elements.specialHolidaysList.appendChild(li);
                });
            }
            
            function setupEventListeners() {
                elements.addSpecialHolidayBtn.addEventListener('click', addSpecialHoliday);
                elements.specialHolidaysList.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('button');
                    if (deleteBtn && deleteBtn.dataset.date) {
                        removeSpecialHoliday(deleteBtn.dataset.date);
                    }
                });
                elements.saveSettingsBtn.addEventListener('click', saveSettings);
            }

            function addSpecialHoliday() {
                const newDate = elements.specialHolidayInput.value;
                if (newDate && !salonSettings.specialHolidays.includes(newDate)) {
                    salonSettings.specialHolidays.push(newDate);
                    renderSpecialHolidays();
                    elements.specialHolidayInput.value = '';
                }
            }

            function removeSpecialHoliday(dateToRemove) {
                salonSettings.specialHolidays = salonSettings.specialHolidays.filter(date => date !== dateToRemove);
                renderSpecialHolidays();
            }

            function saveSettings() {
                const checkedHolidays = [];
                elements.regularHolidaysContainer.querySelectorAll('input:checked').forEach(checkbox => {
                    checkedHolidays.push(parseInt(checkbox.value));
                });
                salonSettings.regularHolidays = checkedHolidays;
                salonSettings.bookingDeadline = parseInt(elements.bookingDeadlineInput.value) || 0;
                salonSettings.openingHour = parseInt(elements.openingHourSelect.value);
                salonSettings.closingHour = parseInt(elements.closingHourSelect.value);
                
                if (salonSettings.openingHour >= salonSettings.closingHour) {
                    alert("終了時間は開始時間より後に設定してください。");
                    return;
                }

                saveSettingsToFirebase();
            }

            function formatDate(dateString) {
                const date = new Date(dateString + 'T00:00:00');
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                return `${year}年${month}月${day}日 (${dayOfWeek})`;
            }
        });
    </script>
</body>
</html>

