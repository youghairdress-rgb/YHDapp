<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YHD AI Diagnosis</title>

        <!-- ▼▼▼ この3行を追加 ▼▼▼ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- ▲▲▲ この3行を追加 ▲▲▲ -->
     
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Poppins:wght@600&display=swap"
        rel="stylesheet">
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .font-poppins {
            font-family: 'Poppins', sans-serif;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
        }

        .delay-1 {
            animation-delay: 0.2s;
        }

        .delay-2 {
            animation-delay: 0.4s;
        }

        .delay-3 {
            animation-delay: 0.6s;
        }

        .delay-4 {
            animation-delay: 0.8s;
        }

        .delay-5 {
            animation-delay: 1.0s;
        }

        .delay-6 {
            animation-delay: 1.2s;
        }

        .delay-7 {
            animation-delay: 1.4s;
        }

        .delay-8 {
            animation-delay: 1.6s;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        @keyframes pulse {
            50% {
                opacity: .5;
            }
        }

        .animate-pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-teal-50 to-white min-h-screen flex items-center justify-center p-4">

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-teal-500"></i>
            <p id="loading-message" class="mt-4 text-gray-600 font-bold">読み込み中...</p>
        </div>
    </div>

    <main id="main-container"
        class="w-full max-w-md mx-auto bg-white/70 backdrop-blur-lg rounded-3xl shadow-2xl shadow-teal-500/10 text-center p-8 md:p-12 overflow-hidden transition-all duration-500"
        style="display: none;">

        <div id="initializing-screen">
            <div class="flex flex-col items-center justify-center py-16">
                <img src="https://firebasestorage.googleapis.com/v0/b/yhddatebase.appspot.com/o/YHDlogo2.png?alt=media&token=437b0aa2-42a0-45c1-acf3-f8da7c2bab3f"
                    alt="YHD YOU-G HAIR DRESS Logo" class="w-24 h-24 mx-auto rounded-full shadow-lg">
                <p class="text-gray-500 text-sm mt-4 animate-pulse-slow">顧客情報を読み込み中...</p>
            </div>
        </div>

        <div id="profile-screen" class="hidden text-left">
            <h2 class="text-xl font-bold text-gray-800 mb-6 text-center fade-in-up">カウンセリング開始</h2>
            <p class="text-center text-gray-600 text-sm mb-6 fade-in-up delay-1">お客様の情報を確認し、撮影に進んでください。</p>
            <div class="space-y-6">
                <div class="fade-in-up delay-1"><label for="line-id"
                        class="block text-sm font-bold text-gray-600 mb-2">LINEユーザーID</label><input type="text"
                        id="line-id" value="" readonly
                        class="w-full px-4 py-3 bg-gray-100 text-gray-500 rounded-lg border-gray-200 focus:outline-none text-xs">
                </div>
                <div class="fade-in-up delay-2"><label for="name"
                        class="block text-sm font-bold text-gray-600 mb-2">お名前</label><input type="text" id="name"
                        readonly
                        class="w-full px-4 py-3 bg-gray-100 text-gray-500 rounded-lg border border-gray-200 focus:outline-none transition">
                </div>
                <div class="fade-in-up delay-3"><label class="block text-sm font-bold text-gray-600 mb-2">性別</label>
                    <div class="flex items-center justify-around bg-white p-2 rounded-lg border border-gray-300"><label
                            class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="gender"
                                value="female" class="text-teal-500 focus:ring-teal-400"><span>女性</span></label><label
                            class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="gender"
                                value="male" class="text-teal-500 focus:ring-teal-400"><span>男性</span></label><label
                            class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="gender"
                                value="other" class="text-teal-500 focus:ring-teal-400"><span>その他</span></label></div>
                </div>
            </div>
            <div class="mt-10 fade-in-up delay-4"><button id="submit-profile-button"
                    class="w-full bg-gray-800 text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-400 focus:ring-opacity-50 transition-all duration-300 transform hover:scale-105">撮影に進む</button>
            </div>
        </div>

        <div id="capture-screen" class="hidden text-left">
            <h2 class="text-xl font-bold text-gray-800 mb-2 text-center fade-in-up">写真・動画撮影</h2>
            <p class="text-center text-gray-600 text-sm mb-6 fade-in-up delay-1">AI診断のため、指定されたアングルから撮影してください。</p>
            <div class="space-y-4">
                <div class="capture-card fade-in-up delay-2" data-id="front-photo">
                    <div class="flex items-center space-x-4">
                        <div
                            class="status-icon bg-gray-200 text-gray-500 rounded-full w-12 h-12 flex items-center justify-center">
                            <ion-icon name="camera-outline" class="text-2xl"></ion-icon>
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">写真：正面</p>
                            <p class="text-sm text-gray-500">顔がはっきりと写るように</p>
                        </div><button
                            class="capture-button bg-white text-teal-600 border border-teal-500 font-bold px-4 py-2 rounded-lg text-sm hover:bg-teal-50 transition">撮影する</button>
                    </div>
                </div>
                <div class="capture-card fade-in-up delay-3" data-id="side-photo">
                    <div class="flex items-center space-x-4">
                        <div
                            class="status-icon bg-gray-200 text-gray-500 rounded-full w-12 h-12 flex items-center justify-center">
                            <ion-icon name="camera-outline" class="text-2xl"></ion-icon>
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">写真：サイド</p>
                            <p class="text-sm text-gray-500">横顔と髪の長さがわかるように</p>
                        </div><button
                            class="capture-button bg-white text-teal-600 border border-teal-500 font-bold px-4 py-2 rounded-lg text-sm hover:bg-teal-50 transition">撮影する</button>
                    </div>
                </div>
                <div class="capture-card fade-in-up delay-4" data-id="back-photo">
                    <div class="flex items-center space-x-4">
                        <div
                            class="status-icon bg-gray-200 text-gray-500 rounded-full w-12 h-12 flex items-center justify-center">
                            <ion-icon name="camera-outline" class="text-2xl"></ion-icon>
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">写真：バック</p>
                            <p class="text-sm text-gray-500">後ろ全体の髪型がわかるように</p>
                        </div><button
                            class="capture-button bg-white text-teal-600 border border-teal-500 font-bold px-4 py-2 rounded-lg text-sm hover:bg-teal-50 transition">撮影する</button>
                    </div>
                </div>
                <div class="capture-card fade-in-up delay-5" data-id="front-video">
                    <div class="flex items-center space-x-4">
                        <div
                            class="status-icon bg-gray-200 text-gray-500 rounded-full w-12 h-12 flex items-center justify-center">
                            <ion-icon name="videocam-outline" class="text-2xl"></ion-icon>
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">動画：正面 (3秒)</p>
                            <p class="text-sm text-gray-500">ゆっくりと左右に顔を動かす</p>
                        </div><button
                            class="capture-button bg-white text-teal-600 border border-teal-500 font-bold px-4 py-2 rounded-lg text-sm hover:bg-teal-50 transition">撮影する</button>
                    </div>
                </div>
                <div class="capture-card fade-in-up delay-5" data-id="back-video">
                    <div class="flex items-center space-x-4">
                        <div
                            class="status-icon bg-gray-200 text-gray-500 rounded-full w-12 h-12 flex items-center justify-center">
                            <ion-icon name="videocam-outline" class="text-2xl"></ion-icon>
                        </div>
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">動画：バック (3秒)</p>
                            <p class="text-sm text-gray-500">髪全体の動きがわかるように</p>
                        </div><button
                            class="capture-button bg-white text-teal-600 border border-teal-500 font-bold px-4 py-2 rounded-lg text-sm hover:bg-teal-50 transition">撮影する</button>
                    </div>
                </div>
            </div>
            <div class="mt-10 fade-in-up delay-5"><button id="submit-diagnosis-button" disabled
                    class="w-full bg-gray-400 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-300 cursor-not-allowed">AI診断をリクエストする</button>
            </div>
        </div>

        <div id="analyzing-screen" class="hidden">
            <div class="flex flex-col items-center justify-center h-full py-16">
                <div class="w-16 h-16 border-4 border-teal-500 border-t-transparent rounded-full spinner mb-6"></div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">AIが診断中です</h2>
                <p id="analyzing-status" class="text-gray-600 text-sm">データベースに情報を保存しています...</p>
            </div>
        </div>

        <div id="results-screen" class="hidden text-left">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center fade-in-up delay-1">AI診断結果</h2>

            <div id="detailed-results-accordion" class="space-y-2 mb-6 fade-in-up delay-2"></div>

            <div id="total-beauty-advice" class="mb-6 fade-in-up delay-3"></div>

            <div class="mb-6 fade-in-up delay-4">
                <div class="mb-6">
                    <h3 class="font-bold text-gray-800 mb-3 text-lg flex items-center"><ion-icon name="cut-outline"
                            class="text-teal-500 mr-2"></ion-icon>ヘアスタイル提案</h3>
                    <div id="hairstyle-suggestions" class="grid grid-cols-2 gap-4"></div>
                </div>
                <div>
                    <h3 class="font-bold text-gray-800 mb-3 text-lg flex items-center"><ion-icon
                            name="color-palette-outline" class="text-teal-500 mr-2"></ion-icon>ヘアカラー提案</h3>
                    <div id="haircolor-suggestions" class="grid grid-cols-2 gap-4"></div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mb-6 fade-in-up delay-5">
                <h3 class="font-bold text-gray-800 mb-3 text-lg flex items-center"><ion-icon name="sparkles-outline"
                        class="text-teal-500 mr-2"></ion-icon>トップスタイリストAIより</h3>
                <div id="result-comment-main" class="text-gray-700 space-y-4 text-sm leading-relaxed"></div>
            </div>

            <div class="mb-6 fade-in-up delay-6 relative"><img id="generated-image"
                    src="https://placehold.co/600x400/E6FFFA/38B2AC?text=AI+Generated+Style" alt="AIが生成した似合わせヘアスタイル"
                    class="rounded-2xl shadow-lg w-full transition-all duration-300">
                <div id="image-loader"
                    class="absolute inset-0 bg-white/70 backdrop-blur-sm rounded-2xl flex items-center justify-center hidden">
                    <div class="w-8 h-8 border-4 border-teal-500 border-t-transparent rounded-full spinner"></div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 mt-6 fade-in-up delay-7">
                <h3 class="font-bold text-gray-800 mb-4 text-lg flex items-center"><ion-icon name="color-wand-outline"
                        class="text-teal-500 mr-2"></ion-icon>画像の微調整</h3>
                <p class="text-sm text-gray-600 mb-4">「もう少し明るく」「前髪を短く」など、ご要望を伝えて画像を調整できます。</p>
                <div class="flex items-center space-x-2"><input type="text" id="adjustment-input"
                        placeholder="例：もう少し髪を明るくして"
                        class="w-full px-4 py-3 bg-gray-50 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-400 transition"><button
                        id="mic-button"
                        class="p-3 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 transition flex-shrink-0"><ion-icon
                            name="mic-outline" class="text-2xl"></ion-icon></button></div><button
                    id="apply-adjustment-button"
                    class="w-full mt-4 bg-gray-800 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-gray-700 transition-all duration-300">変更を反映する</button>
            </div>

            <div class="mt-8 space-y-4 fade-in-up delay-8"><button id="save-button"
                    class="w-full bg-teal-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg shadow-teal-500/30 hover:bg-teal-600 transition-all duration-300 transform hover:scale-105">この結果を保存する</button><button
                    id="restart-button"
                    class="w-full bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-xl hover:bg-gray-300 transition-all duration-300">トップに戻る</button>
            </div>
        </div>

        <div id="error-modal" class="hidden">
            <div class="flex flex-col items-center justify-center py-16 text-center">
                <ion-icon name="warning-outline" class="text-5xl text-red-500 mb-4"></ion-icon>
                <h2 class="text-xl font-bold text-gray-800 mb-2">エラーが発生しました</h2>
                <p id="error-message" class="text-gray-600 text-sm">時間をおいて再度お試しください。</p>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, OAuthProvider, signInWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCD5M3LIs8YPPeQlBecnLi9iaxy2Sco-pI",
                authDomain: "yhddatebase.firebaseapp.com",
                projectId: "yhddatebase",
                storageBucket: "yhddatebase.appspot.com",
                messagingSenderId: "908640006259",
                appId: "1:908640006259:web:f1af7804cf7316ef057a06"
            };
            const ADMIN_LIFF_ID = "2008029428-ANbgw3b6";

            const fbApp = initializeApp(firebaseConfig);
            const auth = getAuth(fbApp);
            const db = getFirestore(fbApp);
            const appId = fbApp.options.projectId;

            const loadingMessage = document.getElementById('loading-message');
            let isAppInitialized = false;

            // ★ onAuthStateChanged監視役を設置
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    if (!isAppInitialized) {
                        initializeAppUI(user);
                    }
                } else {
                    adminLiffLogin();
                }
            });

            async function adminLiffLogin() {
                if (!ADMIN_LIFF_ID || ADMIN_LIFF_ID === "YOUR_ADMIN_LIFF_ID") {
                    loadingMessage.textContent = '管理者用LIFF IDが設定されていません。';
                    return;
                }
                try {
                    await liff.init({ liffId: ADMIN_LIFF_ID });
                    if (!liff.isLoggedIn()) {
                        liff.login({ redirectUri: window.location.href });
                        return;
                    }
                    const idToken = liff.getIDToken();
                    const provider = new OAuthProvider('oidc.line');
                    const credential = provider.credential({ idToken });
                    await signInWithCredential(auth, credential);
                } catch (error) {
                    loadingMessage.textContent = `エラー: ${error.message}`;
                }
            }

            async function initializeAppUI(firebaseUser) {
                const adminRef = doc(db, `admins/${firebaseUser.uid}`);
                const adminDoc = await getDoc(adminRef);
                if (!adminDoc.exists()) {
                    loadingMessage.textContent = "エラー: 管理者権限がありません。";
                    return;
                }

                isAppInitialized = true;
                await main(); // メインのアプリ処理を開始
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
            }

            const screens = {
                initializing: document.getElementById('initializing-screen'),
                profile: document.getElementById('profile-screen'),
                capture: document.getElementById('capture-screen'),
                analyzing: document.getElementById('analyzing-screen'),
                results: document.getElementById('results-screen'),
                error: document.getElementById('error-modal'),
            };
            const buttons = {
                submitProfile: document.getElementById('submit-profile-button'),
                submitDiagnosis: document.getElementById('submit-diagnosis-button'),
                captureButtons: document.querySelectorAll('.capture-button'),
                save: document.getElementById('save-button'),
                restart: document.getElementById('restart-button'),
                mic: document.getElementById('mic-button'),
                applyAdjustment: document.getElementById('apply-adjustment-button'),
            };
            const inputs = {
                name: document.getElementById('name'),
                lineId: document.getElementById('line-id'),
                gender: document.getElementsByName('gender'),
            };
            const analyzingStatusText = document.getElementById('analyzing-status');

            let currentDiagnosisData = {};
            let currentCustomer = null;
            const captureState = { 'front-photo': false, 'side-photo': false, 'back-photo': false, 'front-video': false, 'back-video': false };
            const capturedFiles = {};

            function switchScreen(targetScreen) {
                Object.values(screens).forEach(screen => screen && screen.classList.add('hidden'));
                if (targetScreen) { targetScreen.classList.remove('hidden'); }
            }

            function showError(message) {
                document.getElementById('error-message').textContent = message;
                switchScreen(screens.error);
            }

            async function loadCustomer(customerId) {
                const customerRef = doc(db, `artifacts/${appId}/public/data/customers`, customerId);
                try {
                    const docSnap = await getDoc(customerRef);
                    if (docSnap.exists()) {
                        currentCustomer = { id: docSnap.id, ...docSnap.data() };
                        return true;
                    } else {
                        return false;
                    }
                } catch (error) {
                    console.error("Firebaseからの顧客データ読み込みエラー:", error);
                    showError("顧客データの読み込みに失敗しました。");
                    return false;
                }
            }

            function initializeDiagnosis() {
                const customerId = currentCustomer ? currentCustomer.id : 'UNKNOWN';
                const timestamp = Date.now();
                currentDiagnosisData = {
                    id: `${customerId}-${timestamp}`,
                    customerId: customerId,
                    userName: inputs.name.value,
                    gender: '',
                    createdAt: new Date().toISOString(),
                    results: {}
                };
            }

            function handleCapture(event) {
                const card = event.target.closest('.capture-card');
                const captureId = card.dataset.id;
                const isVideo = captureId.includes('video');
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = isVideo ? 'video/*' : 'image/*';
                input.capture = 'environment';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        capturedFiles[captureId] = file;
                        captureState[captureId] = true;
                        const iconContainer = card.querySelector('.status-icon');
                        const button = card.querySelector('.capture-button');
                        iconContainer.innerHTML = '<ion-icon name="checkmark-circle" class="text-2xl"></ion-icon>';
                        iconContainer.classList.replace('bg-gray-200', 'bg-teal-100');
                        iconContainer.classList.replace('text-gray-500', 'text-teal-600');
                        button.textContent = '再撮影';
                        const allCaptured = Object.values(captureState).every(status => status);
                        if (allCaptured) {
                            buttons.submitDiagnosis.disabled = false;
                            buttons.submitDiagnosis.classList.remove('bg-gray-400', 'cursor-not-allowed');
                            buttons.submitDiagnosis.classList.add('bg-teal-500', 'hover:bg-teal-600');
                        }
                    }
                };
                input.click();
            }

            function displayResults(resultData) {
                currentDiagnosisData.results = resultData;
                const accordionContainer = document.getElementById('detailed-results-accordion');
                const totalBeautyContainer = document.getElementById('total-beauty-advice');
                const hairstyleContainer = document.getElementById('hairstyle-suggestions');
                const haircolorContainer = document.getElementById('haircolor-suggestions');
                const mainCommentContainer = document.getElementById('result-comment-main');

                accordionContainer.innerHTML = '';
                totalBeautyContainer.innerHTML = '';
                hairstyleContainer.innerHTML = '';
                haircolorContainer.innerHTML = '';
                mainCommentContainer.innerHTML = resultData.topStylistComment || '';

                [resultData.skeletal, resultData.facial, resultData.personalColor].forEach(diag => {
                    if (!diag) return;
                    const detailsHtml = Object.entries(diag.items).map(([key, value]) => `<div class="flex justify-between items-center py-2 border-b border-gray-100"><span class="text-sm text-gray-600">${key}</span><span class="font-bold text-gray-800 text-sm">${value}</span></div>`).join('');
                    accordionContainer.innerHTML += `<div class="bg-white border border-gray-200 rounded-xl"><button class="accordion-toggle flex justify-between items-center w-full p-4 text-left"><span class="font-bold text-gray-700 flex items-center"><ion-icon name="${diag.icon}" class="mr-2 text-teal-500"></ion-icon>${diag.title}</span><ion-icon name="chevron-down-outline" class="transition-transform"></ion-icon></button><div class="accordion-content px-4 pb-2">${detailsHtml}</div></div>`;
                });
                [resultData.makeupAdvice, resultData.fashionAdvice].forEach(advice => {
                    if (!advice) return;
                    const detailsHtml = Object.entries(advice.items).map(([key, value]) => `<div class="flex justify-between items-center py-2 border-b border-gray-100"><span class="text-sm text-gray-600">${key}</span><span class="font-bold text-gray-800 text-sm text-right">${value}</span></div>`).join('');
                    totalBeautyContainer.innerHTML += `<div class="bg-white border border-gray-200 rounded-xl mb-2"><button class="accordion-toggle flex justify-between items-center w-full p-4 text-left"><span class="font-bold text-gray-700 flex items-center"><ion-icon name="${advice.icon}" class="mr-2 text-teal-500"></ion-icon>${advice.title}</span><ion-icon name="chevron-down-outline" class="transition-transform"></ion-icon></button><div class="accordion-content px-4 pb-2">${detailsHtml}</div></div>`;
                });
                (resultData.hairstyleSuggestions || []).forEach(style => { hairstyleContainer.innerHTML += `<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"><img src="${style.img || 'https://placehold.co/300x200/EEE/AAA?text=Style'}" alt="${style.name}" class="w-full h-24 object-cover"><div class="p-3"><p class="font-bold text-sm text-gray-800">${style.name}</p><p class="text-xs text-gray-500">${style.desc}</p></div></div>`; });
                (resultData.haircolorSuggestions || []).forEach(color => { haircolorContainer.innerHTML += `<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"><img src="${color.img || 'https://placehold.co/300x200/EEE/AAA?text=Color'}" alt="${color.name}" class="w-full h-24 object-cover"><div class="p-3"><p class="font-bold text-sm text-gray-800">${color.name}</p><p class="text-xs text-gray-500">${color.desc}</p></div></div>`; });

                switchScreen(screens.results);
            }

            async function startAnalysis() {
                for (const radio of inputs.gender) { if (radio.checked) { currentDiagnosisData.gender = radio.value; break; } }
                switchScreen(screens.analyzing);

                const cloudFunctionUrl = "https://asia-northeast1-yhddatebase.cloudfunctions.net/performAiDiagnosis";

                try {
                    analyzingStatusText.textContent = 'AIに診断をリクエストしています...';
                    const response = await fetch(cloudFunctionUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ gender: currentDiagnosisData.gender })
                    });

                    if (!response.ok) throw new Error(`AI診断サーバーからの応答エラー: ${response.status}`);

                    analyzingStatusText.textContent = '診断結果を整形しています...';
                    const resultData = await response.json();
                    displayResults(resultData);

                } catch (error) {
                    console.error("AI診断の実行中にエラー:", error);
                    showError("AI診断の実行に失敗しました。");
                }
            }

            async function saveToDatabase() {
                buttons.save.disabled = true;
                buttons.save.textContent = '保存中...';
                try {
                    if (!currentCustomer) throw new Error("顧客情報が見つかりません。");
                    const visitHistory = currentCustomer.visitHistory || [];
                    const today = new Date().toISOString().split('T')[0];
                    let visit = visitHistory.find(v => v.date === today);

                    if (visit) {
                        visit.diagnosis = currentDiagnosisData;
                    } else {
                        visitHistory.push({
                            date: today,
                            memo: 'AI診断を実施しました。',
                            diagnosis: currentDiagnosisData,
                        });
                    }

                    const customerRef = doc(db, `artifacts/${appId}/public/data/customers`, currentCustomer.id);
                    await updateDoc(customerRef, { visitHistory: visitHistory });

                    alert(`顧客ID: ${currentCustomer.id}\nこの顧客の来店履歴に診断結果を保存しました。`);

                } catch (error) {
                    console.error("データベースへの保存に失敗しました:", error);
                    alert("エラーが発生し、結果を保存できませんでした。");
                } finally {
                    buttons.save.disabled = false;
                    buttons.save.textContent = 'この結果を保存する';
                }
            }

            async function handleUrlParameters() {
                const urlParams = new URLSearchParams(window.location.search);
                const customerId = urlParams.get('customerId');
                if (customerId) {
                    const found = await loadCustomer(customerId);
                    if (found) {
                        inputs.lineId.value = currentCustomer.lineId || 'LINE未連携';
                        inputs.name.value = currentCustomer.name;
                        initializeDiagnosis();
                        switchScreen(screens.profile);
                    } else {
                        showError("指定された顧客情報が見つかりませんでした。");
                    }
                } else {
                    showError("顧客が指定されていません。管理者ページから開始してください。");
                }
            }

            async function main() {
                buttons.submitProfile.addEventListener('click', () => switchScreen(screens.capture));
                buttons.captureButtons.forEach(button => button.addEventListener('click', handleCapture));
                buttons.submitDiagnosis.addEventListener('click', () => { if (!buttons.submitDiagnosis.disabled) { startAnalysis(); } });
                buttons.restart.addEventListener('click', () => { window.location.href = '../admin/index.html' });
                buttons.save.addEventListener('click', saveToDatabase);

                document.addEventListener('click', function (e) {
                    if (e.target.closest('.accordion-toggle')) {
                        const button = e.target.closest('.accordion-toggle');
                        const content = button.nextElementSibling;
                        const icon = button.querySelector('ion-icon[name*="chevron"]');
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                            icon.style.transform = 'rotate(0deg)';
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                            icon.style.transform = 'rotate(180deg)';
                        }
                    }
                });

                await handleUrlParameters();
            }
        });
    </script>

</body>

</html>