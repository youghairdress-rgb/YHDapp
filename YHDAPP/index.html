<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOU-G HAIR Dress 予約</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root {
            --tiffany-blue: #0ABAB5;
            --azure-bg: #F0FFFF;
            --disabled-gray: #D1D5DB;
            --light-tiffany: #E6FFFA;
            --text-dark: #333;
        }

        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--azure-bg);
            color: var(--text-dark);
        }

        .bg-tiffany {
            background-color: var(--tiffany-blue);
        }

        .text-tiffany {
            color: var(--tiffany-blue);
        }

        .border-tiffany {
            border-color: var(--tiffany-blue);
        }

        .btn-primary {
            background-color: var(--tiffany-blue);
            color: white;
            transition: all 0.3s;
            box-shadow: 0 4px 14px 0 rgba(0, 171, 181, 0.39);
        }

        .btn-primary:hover {
            background-color: #089a94;
            box-shadow: 0 6px 20px 0 rgba(0, 171, 181, 0.23);
        }

        .btn-primary:disabled {
            background-color: var(--disabled-gray);
            cursor: not-allowed;
            box-shadow: none;
        }

        .timetable-cell {
            cursor: pointer;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: bold;
            color: var(--tiffany-blue);
        }

        .timetable-cell.available:hover {
            background-color: var(--light-tiffany);
        }

        .timetable-cell.selected {
            background-color: var(--tiffany-blue);
            color: white;
            transform: scale(1.1);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .menu-item {
            border: 1px solid #eee;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

        .menu-item.selected {
            border-color: var(--tiffany-blue);
            background-color: var(--light-tiffany);
            box-shadow: 0 0 0 2px var(--tiffany-blue);
        }

        .menu-item .check-icon {
            border-color: #D1D5DB;
            background-color: white;
        }

        .menu-item .check-icon .fa-check {
            opacity: 0;
        }

        .menu-item.selected .check-icon {
            border-color: var(--tiffany-blue);
            background-color: var(--tiffany-blue);
        }

        .menu-item.selected .check-icon .fa-check {
            opacity: 1;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            color: var(--disabled-gray);
            font-weight: bold;
        }

        .progress-step.active {
            color: var(--tiffany-blue);
        }

        .progress-step .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: white;
            border: 2px solid var(--disabled-gray);
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .progress-step.active .step-circle {
            border-color: var(--tiffany-blue);
            background-color: var(--tiffany-blue);
            color: white;
        }

        .progress-line {
            position: absolute;
            top: 15px;
            left: 50%;
            right: -50%;
            height: 2px;
            background-color: var(--disabled-gray);
            z-index: -1;
        }

        .progress-step:last-child .progress-line {
            display: none;
        }

        .consult-btn.selected {
            background-color: var(--tiffany-blue);
            color: white;
            font-weight: bold;
        }
    </style>
</head>

<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="text-center">
            <i class="fas fa-spinner fa-spin text-4xl text-tiffany"></i>
            <p id="loading-message" class="mt-4 text-gray-600 font-bold">読み込み中...</p>
        </div>
    </div>

    <div id="app" class="max-w-lg mx-auto bg-white min-h-screen shadow-2xl" style="display: none;">
        <header class="bg-tiffany text-white p-4 flex items-center justify-between sticky top-0 z-20 shadow-md">
            <a href="./mypage.html" class="text-white text-lg"><i class="fas fa-user-circle"></i> マイページ</a>
            <h1 id="header-title" class="text-xl font-bold tracking-wider text-center">YHDご予約</h1>
            <div class="w-24"></div>
        </header>

        <main class="p-4 md:p-6">
            <div id="customer-flow">
                <div id="progress-bar" class="flex items-start mb-8">
                    <div class="progress-step active" data-step="1">
                        <div class="step-circle"><i class="fas fa-cut"></i></div>
                        <div class="text-xs">メニュー</div>
                        <div class="progress-line"></div>
                    </div>
                    <div class="progress-step" data-step="2">
                        <div class="step-circle"><i class="fas fa-calendar-alt"></i></div>
                        <div class="text-xs">日時</div>
                        <div class="progress-line"></div>
                    </div>
                    <div class="progress-step" data-step="3">
                        <div class="step-circle"><i class="fas fa-check"></i></div>
                        <div class="text-xs">確認</div>
                    </div>
                </div>

                <div id="step1-menu">
                    <div id="menu-list" class="space-y-4"></div>
                    <div class="mt-8 p-4 bg-gray-50 rounded-xl sticky bottom-4 shadow-inner">
                        <button id="to-step2-btn" class="w-full btn-primary py-3 rounded-lg font-bold text-lg"
                            disabled>日時選択へ</button>
                    </div>
                </div>

                <div id="step2-datetime" class="hidden">
                    <div class="bg-gray-50 p-3 rounded-xl mb-4 shadow-sm">
                        <div class="flex justify-between items-center">
                            <button id="prev-week-btn" class="p-2 rounded-full hover:bg-gray-200"><i
                                    class="fas fa-chevron-left"></i></button>
                            <h3 id="week-display" class="font-bold text-lg text-center"></h3>
                            <button id="next-week-btn" class="p-2 rounded-full hover:bg-gray-200"><i
                                    class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div id="timetable" class="text-center border-t border-r border-gray-200"></div>
                    <div class="mt-6">
                        <label for="requests" class="block font-medium text-gray-700 mb-2">その他ご要望</label>
                        <textarea id="requests" rows="3"
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-tiffany focus:ring-tiffany"
                            placeholder="（例）静かに過ごしたいです"></textarea>
                    </div>
                    <div class="mt-8 grid grid-cols-2 gap-4">
                        <button id="back-to-step1-btn"
                            class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-bold">戻る</button>
                        <button id="to-step3-btn" class="w-full btn-primary py-3 rounded-lg font-bold text-lg"
                            disabled>予約確認へ</button>
                    </div>
                </div>

                <div id="step3-confirm" class="hidden">
                    <h2 class="text-xl font-bold mb-4 text-center">ご予約内容の確認</h2>
                    <div class="bg-gray-50 p-5 rounded-xl space-y-4 shadow-sm">
                        <div>
                            <label for="confirm-full-name" class="font-bold text-gray-500 text-sm flex items-center"><i
                                    class="far fa-user mr-2"></i>お名前 (フルネーム)<span
                                    class="text-red-500 ml-2">*必須</span></label>
                            <input type="text" id="confirm-full-name" class="w-full mt-1 rounded-md border-gray-300"
                                placeholder="例: 山田 花子">
                        </div>
                        <hr>
                        <div>
                            <h3 class="font-bold text-gray-500 text-sm flex items-center"><i
                                    class="fab fa-line mr-2"></i>LINE ID</h3>
                            <p id="confirm-line-name" class="text-lg font-bold ml-5"></p>
                        </div>
                        <hr>
                        <div>
                            <h3 class="font-bold text-gray-500 text-sm flex items-center"><i
                                    class="far fa-calendar-check mr-2"></i>日時</h3>
                            <p id="confirm-datetime" class="text-lg font-bold ml-5"></p>
                        </div>
                        <hr>
                        <div>
                            <h3 class="font-bold text-gray-500 text-sm flex items-center"><i
                                    class="fas fa-cut mr-2"></i>選択メニュー</h3>
                            <ul id="confirm-menu" class="space-y-1 mt-2 ml-5"></ul>
                        </div>
                        <hr>
                        <div>
                            <h3 class="font-bold text-gray-500 text-sm flex items-center"><i
                                    class="far fa-clock mr-2"></i>所要時間の目安</h3>
                            <p id="confirm-duration" class="text-lg font-bold ml-5"></p>
                        </div>
                        <hr>
                        <div>
                            <h3 class="font-bold text-gray-500 text-sm flex items-center"><i
                                    class="fas fa-yen-sign mr-2"></i>合計金額 (概算)</h3>
                            <p id="confirm-price" class="text-2xl font-bold text-tiffany ml-5"></p>
                            <p class="text-xs text-gray-500 mt-1 ml-5">※消費税・ロング料金が加算される場合があります</p>
                        </div>
                        <div id="confirm-requests-wrapper" class="hidden">
                            <hr>
                            <h3 class="font-bold text-gray-500 text-sm flex items-center"><i
                                    class="far fa-comment-dots mr-2"></i>ご要望</h3>
                            <p id="confirm-requests" class="whitespace-pre-wrap bg-white p-3 rounded-md mt-1 ml-5"></p>
                        </div>
                    </div>
                    <div class="mt-8 grid grid-cols-2 gap-4">
                        <button id="back-to-step2-btn"
                            class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-bold">戻る</button>
                        <button id="confirm-booking-btn" class="w-full btn-primary py-3 rounded-lg font-bold text-lg"
                            disabled>予約を確定する</button>
                    </div>
                </div>

                <div id="booking-complete" class="hidden text-center py-16">
                    <div class="text-7xl text-tiffany mb-4"><i class="fas fa-check-circle"></i></div>
                    <h2 class="text-3xl font-bold mb-2">予約完了しました！</h2>
                    <p class="text-gray-600">ご来店を心よりお待ちしております♪<br>詳細はLINEのメッセージをご確認ください。</p>
                    <button id="close-liff-btn"
                        class="w-full btn-primary py-3 rounded-lg mt-12 font-bold text-lg">画面を閉じる</button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, OAuthProvider, signInWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, getDocs, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCD5M3LIs8YPPeQlBecnLi9iaxy2Sco-pI",
                authDomain: "yhddatebase.firebaseapp.com",
                projectId: "yhddatebase",
                storageBucket: "yhddatebase.appspot.com",
                messagingSenderId: "908640006259",
                appId: "1:908640006259:web:f1af7804cf7316ef057a06"
            };
            const USER_LIFF_ID = "2008029428-o47wql7A";

            const fbApp = initializeApp(firebaseConfig);
            const auth = getAuth(fbApp);
            const db = getFirestore(fbApp);
            const appId = fbApp.options.projectId;

            const loadingMessage = document.getElementById('loading-message');
            let isAppInitialized = false;

            // ★★★★★ START: 認証フローの最終修正 (v17) ★★★★★
            // Firebaseの認証状態を監視する
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Firebaseにログイン済み
                    if (!isAppInitialized) {
                        initializeAppUI(user);
                    }
                } else {
                    // Firebaseに未ログイン
                    liffLogin();
                }
            });

            async function liffLogin() {
                try {
                    // 1. LIFFを初期化
                    await liff.init({ liffId: USER_LIFF_ID });
                    // 2. LIFFにログインしていなければ、ログインページに遷移
                    if (!liff.isLoggedIn()) {
                        liff.login({ redirectUri: window.location.href });
                        return;
                    }
                    // 3. LIFFのIDトークンを取得してFirebaseにログイン
                    const idToken = liff.getIDToken();
                    if (!idToken) throw new Error("LINEのIDトークンが取得できませんでした。");

                    const provider = new OAuthProvider('oidc.line');
                    const credential = provider.credential({ idToken });
                    await signInWithCredential(auth, credential);
                    // 成功するとonAuthStateChangedが再度呼び出され、initializeAppUIが実行される
                } catch (error) {
                    loadingMessage.textContent = `エラー: ${error.message}`;
                    console.error("LIFF Login Error:", error);
                }
            }

            async function initializeAppUI(firebaseUser) {
                if (!firebaseUser) {
                    loadingMessage.textContent = "エラー: ユーザー情報が取得できません。";
                    return;
                }

                isAppInitialized = true;
                try {
                    // この時点でliff.initは完了しているはずなので、直接liff.getProfileを呼ぶ
                    loadingMessage.textContent = 'プロフィール情報を取得中...';
                    appState.profile = await liff.getProfile(); // このAPI呼び出しにはaccess_tokenが必要

                    loadingMessage.textContent = '予約データを読み込み中...';
                    await loadAllDataFromFirebase();

                    loadingMessage.textContent = '画面を準備中...';
                    renderAll();
                    setupEventListeners();
                    updateProgress(1);

                    document.getElementById('loading-overlay').style.display = 'none';
                    document.getElementById('app').style.display = 'block';

                } catch (error) {
                    console.error("Initialization failed after login:", error);
                    loadingMessage.textContent = `アプリの起動に失敗しました: ${error.message}`;
                }
            }
            // ★★★★★ END: 認証フローの最終修正 (v17) ★★★★★


            let menuData = [];
            let menuCategories = [];
            let salonSettings = {};
            let adminBookingData = {};

            const appState = {
                currentStep: 1,
                selectedMenus: [],
                selectedDate: null,
                selectedTime: null,
                profile: null,
                requests: '',
                fullName: '',
                currentWeekStartDate: getStartOfWeek(new Date()),
            };

            const screens = {
                step1: document.getElementById('step1-menu'),
                step2: document.getElementById('step2-datetime'),
                step3: document.getElementById('step3-confirm'),
                complete: document.getElementById('booking-complete'),
            };
            const elements = {
                menuList: document.getElementById('menu-list'),
                toStep2Btn: document.getElementById('to-step2-btn'),
                weekDisplay: document.getElementById('week-display'),
                timetable: document.getElementById('timetable'),
                toStep3Btn: document.getElementById('to-step3-btn'),
                confirmFullName: document.getElementById('confirm-full-name'),
                confirmLineName: document.getElementById('confirm-line-name'),
                confirmDatetime: document.getElementById('confirm-datetime'),
                confirmMenu: document.getElementById('confirm-menu'),
                confirmDuration: document.getElementById('confirm-duration'),
                confirmPrice: document.getElementById('confirm-price'),
                confirmRequests: document.getElementById('confirm-requests'),
                confirmRequestsWrapper: document.getElementById('confirm-requests-wrapper'),
                confirmBookingBtn: document.getElementById('confirm-booking-btn'),
                requestsInput: document.getElementById('requests'),
                progressBar: document.getElementById('progress-bar'),
                backToStep1Btn: document.getElementById('back-to-step1-btn'),
                backToStep2Btn: document.getElementById('back-to-step2-btn'),
                closeLiffBtn: document.getElementById('close-liff-btn'),
                prevWeekBtn: document.getElementById('prev-week-btn'),
                nextWeekBtn: document.getElementById('next-week-btn'),
            };

            async function loadAllDataFromFirebase() {
                const menuRef = doc(db, `artifacts/${appId}/public/data/menuData`, "menus");
                const categoriesRef = doc(db, `artifacts/${appId}/public/data/menuData`, "categories");
                const settingsRef = doc(db, `artifacts/${appId}/public/data/salonSettings`, "config");
                const bookingsCol = collection(db, `artifacts/${appId}/public/data/bookings`);

                try {
                    const [menuDoc, categoryDoc, settingsDoc, bookingSnapshot] = await Promise.all([
                        getDoc(menuRef), getDoc(categoriesRef), getDoc(settingsRef), getDocs(bookingsCol)
                    ]);
                    menuData = menuDoc.exists() ? menuDoc.data().items : [];
                    menuCategories = categoryDoc.exists() ? categoryDoc.data().items : [];
                    salonSettings = settingsDoc.exists() ? settingsDoc.data() : {};

                    adminBookingData = {};
                    bookingSnapshot.forEach(doc => {
                        const data = doc.data();
                        const dateStr = data.date;
                        if (!adminBookingData[dateStr]) {
                            adminBookingData[dateStr] = [];
                        }
                        adminBookingData[dateStr].push(data);
                    });
                } catch (error) {
                    console.error("Firebaseからのデータ読み込みエラー:", error);
                    throw new Error(`データベースからのデータ読み込みに失敗しました。(${error.code || error.message})`);
                }
            }

            async function saveBookingToFirebase() {
                elements.confirmBookingBtn.disabled = true;
                elements.confirmBookingBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 処理中';

                const user = auth.currentUser;
                if (!user) {
                    alert('ログイン情報が見つかりません。');
                    elements.confirmBookingBtn.disabled = false;
                    elements.confirmBookingBtn.textContent = '予約を確定する';
                    return;
                }

                appState.fullName = elements.confirmFullName.value.trim();
                if (!appState.fullName) {
                    alert('お名前（フルネーム）を入力してください。');
                    elements.confirmBookingBtn.disabled = false;
                    elements.confirmBookingBtn.textContent = '予約を確定する';
                    return;
                }

                let endTime = '';
                if (appState.selectedTime !== "時間相談") {
                    const totalDuration = calculateTotalDuration(appState.selectedMenus);
                    endTime = calculateEndTime(appState.selectedTime, totalDuration);
                }

                const newBooking = {
                    id: Date.now(),
                    date: appState.selectedDate,
                    startTime: appState.selectedTime,
                    endTime: endTime,
                    customerId: user.uid,
                    customerName: appState.fullName,
                    lineDisplayName: appState.profile.displayName,
                    menuIds: appState.selectedMenus.map(m => m.id),
                    requests: appState.requests,
                    status: "consulting",
                    type: "booking"
                };
                if (appState.selectedTime !== "時間相談") {
                    newBooking.status = "booked";
                }


                try {
                    const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/bookings`), newBooking);
                    await updateDoc(docRef, { bookingDocId: docRef.id });

                    const customerRef = doc(db, `artifacts/${appId}/public/data/customers`, user.uid);
                    const customerDoc = await getDoc(customerRef);

                    if (customerDoc.exists()) {
                        await updateDoc(customerRef, {
                            name: appState.fullName,
                            lineDisplayName: appState.profile.displayName
                        });
                    } else {
                        await setDoc(customerRef, {
                            name: appState.fullName,
                            lineDisplayName: appState.profile.displayName,
                            lineId: user.uid,
                            visitHistory: []
                        });
                    }

                    let confirmationText = `${appState.fullName}様\n\nご予約ありがとうございます。\n\n`;
                    if (appState.selectedTime === "時間相談") {
                        confirmationText += `日時: ${appState.selectedDate} (時間相談)\n`;
                        confirmationText += `選択メニュー: ${appState.selectedMenus.map(m => m.name).join(', ')}\n\n`;
                        confirmationText += `追って担当者よりご連絡いたしますので、少々お待ちください。`;
                    } else {
                        confirmationText += `日時: ${appState.selectedDate} ${appState.selectedTime}\n`;
                        confirmationText += `メニュー: ${appState.selectedMenus.map(m => m.name).join(', ')}\n\n`;
                        confirmationText += `ご来店を心よりお待ちしております。`;
                    }
                    await liff.sendMessages([{ type: 'text', text: confirmationText }]);

                    switchScreen('complete');

                } catch (error) {
                    console.error("FirebaseまたはLIFFの処理でエラー:", error);
                    if (error.code) {
                        alert(`予約の保存に失敗しました。\nLINEへのメッセージ送信ができませんでした。\nLIFFアプリに必要な権限が許可されているかご確認ください。\nエラー: ${error.message}`);
                    } else {
                        alert('予約の保存に失敗しました。データベースへの書き込み中にエラーが発生した可能性があります。');
                    }
                    elements.confirmBookingBtn.disabled = false;
                    elements.confirmBookingBtn.textContent = '予約を確定する';
                }
            }

            function renderAll() {
                renderMenuList();
                renderCustomerTimetable();
            }

            function renderMenuList() {
                elements.menuList.innerHTML = '';
                if (menuCategories.length === 0) {
                    elements.menuList.innerHTML = `<div class="text-center text-gray-500 p-8 bg-gray-50 rounded-lg"><i class="fas fa-info-circle text-4xl mb-4 text-gray-400"></i><p class="font-bold">現在、予約可能なメニューがありません。</p><p class="text-sm mt-2">しばらくしてから再度お試しください。</p></div>`;
                    elements.toStep2Btn.disabled = true;
                    return;
                }

                menuCategories.sort((a, b) => a.order - b.order).forEach(cat => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'border rounded-xl shadow-sm';
                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-center p-4 cursor-pointer';
                    header.innerHTML = `<h3 class="font-bold text-lg flex items-center"><i class="fas ${cat.icon || 'fa-star'} mr-3 text-tiffany w-6 text-center"></i>${cat.name}</h3><i class="fas fa-chevron-down transition-transform"></i>`;
                    const content = document.createElement('div');
                    content.className = 'accordion-content';
                    const listContainer = document.createElement('div');
                    listContainer.className = 'p-4 pt-0 space-y-2';
                    menuData.filter(m => m.category === cat.name).sort((a, b) => a.order - b.order).forEach(item => {
                        const menuItemDiv = document.createElement('div');
                        menuItemDiv.className = 'menu-item flex justify-between items-center';
                        menuItemDiv.dataset.id = item.id;
                        const priceText = item.priceFrom ? `¥${item.price.toLocaleString()}~` : `¥${item.price.toLocaleString()}`;
                        const descriptionHtml = item.description ? `<p class="text-xs text-gray-500 mt-1">${item.description}</p>` : '';
                        menuItemDiv.innerHTML = `
                            <div class="flex-1 pr-4">
                                <p class="font-bold">${item.name}</p>
                                <p class="text-sm text-gray-500">${priceText}</p>
                                ${descriptionHtml}
                            </div>
                            <div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 check-icon">
                                <i class="fas fa-check text-white text-xs transition-opacity"></i>
                            </div>`;
                        listContainer.appendChild(menuItemDiv);
                    });
                    content.appendChild(listContainer);
                    categoryDiv.appendChild(header);
                    categoryDiv.appendChild(content);
                    elements.menuList.appendChild(categoryDiv);

                    header.addEventListener('click', () => {
                        const icon = header.querySelector('i.fa-chevron-down');
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                            icon.classList.remove('rotate-180');
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                            icon.classList.add('rotate-180');
                        }
                    });
                });
            }

            function renderCustomerTimetable() {
                const startDate = appState.currentWeekStartDate;
                elements.weekDisplay.textContent = `${formatDate(startDate, 'M/D')} - ${formatDate(new Date(new Date(startDate).setDate(startDate.getDate() + 6)), 'M/D')}`;
                elements.timetable.innerHTML = '';

                const headerRow = document.createElement('div');
                headerRow.className = 'grid grid-cols-8 text-xs';
                headerRow.innerHTML = '<div class="border-l border-b border-gray-200"></div>';
                const days = ['日', '月', '火', '水', '木', '金', '土'];
                for (let i = 0; i < 7; i++) {
                    const d = new Date(startDate); d.setDate(startDate.getDate() + i);
                    const dayOfWeek = d.getDay();
                    let colorClass = '';
                    if (dayOfWeek === 0) colorClass = 'text-red-500'; if (dayOfWeek === 6) colorClass = 'text-blue-500';
                    headerRow.innerHTML += `<div class="text-center ${colorClass} font-bold p-1 border-l border-b border-gray-200">${d.getDate()}<br>${days[dayOfWeek]}</div>`;
                }
                elements.timetable.appendChild(headerRow);

                const consultRow = document.createElement('div');
                consultRow.className = 'grid grid-cols-8 text-xs';
                consultRow.innerHTML = '<div class="border-l border-b border-gray-200"></div>'; // Empty cell for the time column
                for (let i = 0; i < 7; i++) {
                    const d = new Date(startDate);
                    d.setDate(startDate.getDate() + i);
                    const dateStr = getFormattedDate(d);
                    consultRow.innerHTML += `
                        <div class="text-center p-1 border-l border-b border-gray-200 flex items-center justify-center h-full">
                            <button class="consult-btn text-xs bg-gray-600 text-white px-2 py-1 rounded hover:bg-gray-700 w-full" data-date="${dateStr}">相談</button>
                        </div>`;
                }
                elements.timetable.appendChild(consultRow);

                for (let hour = salonSettings.openingHour || 10; hour < (salonSettings.closingHour || 20); hour++) {
                    for (let minute = 0; minute < 60; minute += 30) {
                        const time = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                        const timeRow = document.createElement('div');
                        timeRow.className = 'grid grid-cols-8 items-center';
                        timeRow.innerHTML = `<div class="text-xs text-gray-500 text-right pr-2 border-l border-b border-gray-200 h-full flex items-center justify-end">${time}</div>`;
                        for (let i = 0; i < 7; i++) {
                            const d = new Date(startDate); d.setDate(startDate.getDate() + i);
                            const dateStr = getFormattedDate(d);
                            const isAvailable = checkAvailability(dateStr, time);
                            let cellContent = isAvailable ? `<div class="timetable-cell available" data-date="${dateStr}" data-time="${time}">◎</div>` : '<div class="text-gray-300">-</div>';
                            timeRow.innerHTML += `<div class="flex justify-center items-center h-12 border-l border-b border-gray-200">${cellContent}</div>`;
                        }
                        elements.timetable.appendChild(timeRow);
                    }
                }
                updateCustomerTimetableSelection();
            }

            function updateCustomerTimetableSelection() {
                document.querySelectorAll(".timetable-cell").forEach(e => e.classList.remove("selected"));
                document.querySelectorAll(".consult-btn").forEach(e => e.classList.remove("selected"));

                const { selectedDate, selectedTime } = appState;
                if (selectedDate && selectedTime) {
                    if (selectedTime === "時間相談") {
                        const btn = document.querySelector(`.consult-btn[data-date="${selectedDate}"]`);
                        if (btn) btn.classList.add("selected");
                    } else {
                        const cell = document.querySelector(`.timetable-cell[data-date="${selectedDate}"][data-time="${selectedTime}"]`);
                        if (cell) cell.classList.add("selected");
                    }
                }
            }

            function handleConsultationSelection(target) {
                appState.selectedDate = target.dataset.date;
                appState.selectedTime = "時間相談";
                updateCustomerTimetableSelection();
                validateStep2();
            }

            function renderConfirmScreen() {
                elements.confirmLineName.textContent = appState.profile.displayName;
                const date = new Date(`${appState.selectedDate}T00:00:00`);
                const dayOfWeek = ["日", "月", "火", "水", "木", "金", "土"][date.getDay()];

                if (appState.selectedTime === "時間相談") {
                    elements.confirmDatetime.textContent = `${formatDate(date, "YYYY年M月D日")}(${dayOfWeek}) 時間相談`;
                } else {
                    elements.confirmDatetime.textContent = `${formatDate(date, "YYYY年M月D日")}(${dayOfWeek}) ${appState.selectedTime}`;
                }

                elements.confirmMenu.innerHTML = "";
                let totalPrice = 0;
                let totalDuration = 0;
                appState.selectedMenus.forEach(menu => {
                    const li = document.createElement("li");
                    li.innerHTML = `<span>${menu.name}</span> <span class="font-sans">${menu.price.toLocaleString()}円</span>`;
                    li.className = "flex justify-between";
                    elements.confirmMenu.appendChild(li);
                    totalPrice += menu.price;
                    totalDuration += menu.duration;
                });
                elements.confirmPrice.textContent = `¥${totalPrice.toLocaleString()}`;
                elements.confirmDuration.textContent = `${totalDuration}分`;

                if (appState.requests.trim()) {
                    elements.confirmRequestsWrapper.classList.remove("hidden");
                    elements.confirmRequests.textContent = appState.requests;
                } else {
                    elements.confirmRequestsWrapper.classList.add("hidden");
                }
            }

            function setupEventListeners() {
                elements.toStep2Btn.addEventListener('click', () => switchScreen('step2'));
                elements.backToStep1Btn.addEventListener('click', () => switchScreen('step1'));
                elements.toStep3Btn.addEventListener('click', () => {
                    appState.requests = elements.requestsInput.value;
                    renderConfirmScreen();
                    switchScreen('step3');
                });
                elements.backToStep2Btn.addEventListener('click', () => switchScreen('step2'));
                elements.confirmBookingBtn.addEventListener('click', saveBookingToFirebase);
                elements.closeLiffBtn.addEventListener('click', () => liff.closeWindow());
                elements.prevWeekBtn.addEventListener('click', () => changeCustomerWeek(-7));
                elements.nextWeekBtn.addEventListener('click', () => changeCustomerWeek(7));

                elements.menuList.addEventListener('click', (e) => {
                    const target = e.target.closest('.menu-item');
                    if (target) handleMenuSelection(target);
                });

                elements.timetable.addEventListener('click', (e) => {
                    const targetCell = e.target.closest('.timetable-cell.available');
                    if (targetCell) {
                        handleCustomerTimeSelection(targetCell);
                        return;
                    }
                    const targetConsultBtn = e.target.closest('.consult-btn');
                    if (targetConsultBtn) {
                        handleConsultationSelection(targetConsultBtn);
                    }
                });

                elements.confirmFullName.addEventListener('input', () => {
                    elements.confirmBookingBtn.disabled = elements.confirmFullName.value.trim() === '';
                });
            }

            function handleMenuSelection(target) {
                const menuId = parseInt(target.dataset.id);
                const menu = menuData.find(m => m.id === menuId);
                target.classList.toggle("selected");
                if (appState.selectedMenus.some(m => m.id === menuId)) {
                    appState.selectedMenus = appState.selectedMenus.filter(m => m.id !== menuId);
                } else {
                    appState.selectedMenus.push(menu);
                }
                renderCustomerTimetable();
                validateStep1();
            }

            function handleCustomerTimeSelection(target) {
                appState.selectedDate = target.dataset.date;
                appState.selectedTime = target.dataset.time;
                updateCustomerTimetableSelection();
                validateStep2();
            }

            function changeCustomerWeek(days) {
                appState.currentWeekStartDate.setDate(appState.currentWeekStartDate.getDate() + days);
                renderCustomerTimetable();
            }

            function validateStep1() { elements.toStep2Btn.disabled = appState.selectedMenus.length === 0; }
            function validateStep2() { elements.toStep3Btn.disabled = !appState.selectedDate || !appState.selectedTime; }

            function switchScreen(stepKey) {
                const stepMap = { 'step1': 1, 'step2': 2, 'step3': 3, 'complete': 4 };
                appState.currentStep = stepMap[stepKey] || 0;
                Object.values(screens).forEach(s => s.classList.add('hidden'));
                if (screens[stepKey]) screens[stepKey].classList.remove('hidden');
                updateProgress(appState.currentStep);
                window.scrollTo(0, 0);
            }

            function updateProgress(step) {
                elements.progressBar.querySelectorAll(".progress-step").forEach(s => {
                    s.classList.toggle("active", parseInt(s.dataset.step) <= step);
                });
            }

            function getStartOfWeek(date) { const d = new Date(date); const day = d.getDay(); const diff = d.getDate() - day; return new Date(d.setDate(diff)); }
            function formatDate(date, format) { return format.replace('YYYY', date.getFullYear()).replace('M', date.getMonth() + 1).replace('D', date.getDate()); }
            function getFormattedDate(date) { const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }

            function calculateTotalDuration(menus) {
                return menus.reduce((total, menu) => total + menu.duration, 0);
            }

            function calculateEndTime(startTime, duration) {
                const start = new Date(`2000-01-01T${startTime}`);
                const end = new Date(start.getTime() + duration * 60000);
                return `${String(end.getHours()).padStart(2, '0')}:${String(end.getMinutes()).padStart(2, '0')}`;
            }

            function checkAvailability(dateStr, timeStr) {
                const now = new Date();
                const proposedStart = new Date(`${dateStr}T${timeStr}:00`);
                if (proposedStart < now) return false;

                const dayOfWeek = proposedStart.getDay();
                if (salonSettings.regularHolidays?.includes(dayOfWeek)) return false;
                if (salonSettings.specialHolidays?.includes(dateStr)) return false;

                const deadlineMinutes = salonSettings.bookingDeadline || 60;
                const deadline = new Date(now.getTime() + deadlineMinutes * 60000);
                if (proposedStart < deadline) return false;

                const totalDuration = calculateTotalDuration(appState.selectedMenus);
                if (totalDuration === 0) return false;
                const proposedEnd = new Date(proposedStart.getTime() + totalDuration * 60000);

                const openingHour = salonSettings.openingHour || 10;
                const closingHour = salonSettings.closingHour || 20;
                if (proposedStart.getHours() < openingHour || proposedEnd.getHours() > closingHour || (proposedEnd.getHours() === closingHour && proposedEnd.getMinutes() > 0)) {
                    return false;
                }

                const bookingsOnDate = adminBookingData[dateStr] || [];
                for (const booking of bookingsOnDate) {
                    const bookingStart = new Date(`${dateStr}T${booking.startTime}`);
                    const bookingEnd = new Date(`${dateStr}T${booking.endTime}`);
                    if (proposedStart < bookingEnd && proposedEnd > bookingStart) {
                        return false;
                    }
                }
                return true;
            }
        });
    </script>
</body>

</html>